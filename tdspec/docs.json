[{"name":"DebugHub","comment":" DebugHub — the message router inside agent-reverse-proxy.\n\nManages three subscriber pools:\n\n  - **UI observers:** terminal-ui instances connected via `/ui` (WS 3,4)\n  - **Shell page:** connected via `/ws` (WS 5)\n  - **inject.js:** connected via `/ws` (WS 6)\n\nRouting rules:\n\n    Source               -> Destination\n    Shell page sends     -> BroadcastToUiObservers (FromShellPage msg)\n    inject.js sends      -> BroadcastToUiObservers (FromInject msg)\n    HTTP GET /open       -> SendToUiObserversOnly (Open)\n    UI Navigate/Reload   -> ForwardToShellPage\n    UI Query             -> ForwardToInject\n\n@docs Effect, onShellPageMessage, onInjectMessage, onOpenRequest, onUiCommand\n\n","unions":[{"name":"Effect","comment":" Side effects produced by the DebugHub routing logic.\n","args":[],"cases":[["BroadcastToUiObservers",["DebugProtocol.AllDebugMsg"]],["SendToUiObserversOnly",["DebugProtocol.AllDebugMsg"]],["ForwardToShellPage",["DebugProtocol.ShellPageCommand"]],["ForwardToInject",["DebugProtocol.InjectCommand"]]]}],"aliases":[],"values":[{"name":"onInjectMessage","comment":" When inject.js (WS 6) sends a message, the hub\nbroadcasts it to all UI observers as a AllDebugMsg.\n","type":"DebugProtocol.InjectJsDebugMsg -> List.List DebugHub.Effect"},{"name":"onOpenRequest","comment":" When the swe-swe-open CLI shim hits `HTTP GET /open?url=...`,\nthe hub broadcasts an `Open` message to all UI observers.\nThis is the source of the duplicate-prompt bug — all terminal-ui\ninstances receive and handle it.\n","type":"{ url : Domain.Url } -> List.List DebugHub.Effect"},{"name":"onShellPageMessage","comment":" When the shell page (WS 5) sends a message, the hub\nbroadcasts it to all UI observers as a AllDebugMsg.\n","type":"DebugProtocol.ShellPageDebugMsg -> List.List DebugHub.Effect"},{"name":"onUiCommand","comment":" When a UI observer (WS 3,4) sends a command, the hub\nroutes it to the appropriate iframe client:\nNavigate/Reload → shell page, Query → inject.js.\n","type":"DebugProtocol.UiCommand -> List.List DebugHub.Effect"}],"binops":[]},{"name":"DebugProtocol","comment":" Debug channel protocol types, split by client.\n\nShell page (WS 5) handles navigation: page loads, URL changes, back/forward.\ninject.js (WS 6) handles telemetry: console, errors, network, DOM queries.\nAllDebugMsg is the aggregate that UI observers (terminal-ui on WS 3,4) receive.\n\nEndpoints (on agent-reverse-proxy at `:PROXY_PORT_OFFSET+port`):\n\n    /__agent-reverse-proxy-debug__/ui   -- terminal-ui connects here  (WS 3,4)\n    /__agent-reverse-proxy-debug__/ws   -- shell page & inject.js     (WS 5,6)\n\nAll messages use JSON with a `t` (type) discriminator field.\n\n@docs ShellPageDebugMsg, ShellPageCommand\n@docs InjectJsDebugMsg, InjectCommand, HttpResult\n@docs AllDebugMsg, UiCommand, NavigateAction\n\n","unions":[{"name":"AllDebugMsg","comment":" Messages received by UI observers (terminal-ui) from the hub.\nAggregate of all sources: shell page, inject.js, and HTTP /open.\n","args":[],"cases":[["FromShellPage",["DebugProtocol.ShellPageDebugMsg"]],["FromInject",["DebugProtocol.InjectJsDebugMsg"]],["Open",["{ url : Domain.Url }"]]]},{"name":"HttpResult","comment":" Result of an HTTP request (Fetch API or XMLHttpRequest).\n","args":[],"cases":[["HttpResult",["{ request : { url : Domain.Url, method : String.String, ms : Basics.Int, ts : Domain.Timestamp }, response : Result.Result { error : String.String } { httpStatus : Basics.Int } }"]]]},{"name":"InjectCommand","comment":" Commands sent by the hub to inject.js.\n","args":[],"cases":[["DomQuery",["{ id : String.String, selector : String.String }"]]]},{"name":"InjectJsDebugMsg","comment":" Messages sent by inject.js to the hub.\nTelemetry: console output, errors, network activity, DOM query results.\n","args":[],"cases":[["Console",["{ m : String.String, args : List.List String.String, ts : Domain.Timestamp }"]],["Error",["{ msg : String.String, file : String.String, line : Basics.Int, col : Basics.Int, stack : Maybe.Maybe String.String, ts : Domain.Timestamp }"]],["Rejection",["{ reason : String.String, ts : Domain.Timestamp }"]],["Fetch",["DebugProtocol.HttpResult"]],["Xhr",["DebugProtocol.HttpResult"]],["QueryResult",["{ id : String.String, found : Basics.Bool, text : Maybe.Maybe String.String, html : Maybe.Maybe String.String, visible : Basics.Bool, rect : Maybe.Maybe { x : Basics.Float, y : Basics.Float, width : Basics.Float, height : Basics.Float } }"]],["WsUpgrade",["{ from : Domain.Url, to : Domain.Url, ts : Domain.Timestamp }"]]]},{"name":"NavigateAction","comment":" Navigation direction.\n","args":[],"cases":[["ToUrl",["Domain.Url"]],["Back",[]],["Forward",[]]]},{"name":"ShellPageCommand","comment":" Commands sent by the hub to the shell page.\n","args":[],"cases":[["ShellNavigate",["DebugProtocol.NavigateAction"]],["ShellReload",[]]]},{"name":"ShellPageDebugMsg","comment":" Messages sent by the shell page to the hub.\nNavigation-related: page loads, URL changes, back/forward state.\n","args":[],"cases":[["Init",["{ url : Domain.Url, ts : Domain.Timestamp }"]],["UrlChange",["{ url : Domain.Url, ts : Domain.Timestamp }"]],["NavState",["{ canGoBack : Basics.Bool, canGoForward : Basics.Bool }"]]]},{"name":"UiCommand","comment":" Commands sent by terminal-ui to the hub (on WS 3,4).\nThe hub routes Navigate/Reload to the shell page, Query to inject.js.\n","args":[],"cases":[["Navigate",["DebugProtocol.NavigateAction"]],["Reload",[]],["Query",["{ id : String.String, selector : String.String }"]]]}],"aliases":[],"values":[],"binops":[]},{"name":"Domain","comment":" Shared primitive types used across the architecture.\n\nSystem overview:\n\n  - Browser page hosts 2x terminal-ui web components + 1x Preview iframe\n  - Container runs swe-swe-server (PTY) + agent-reverse-proxy (debug/preview)\n  - 4 WebSockets + 1 HTTP endpoint connect them (+ 2 more when Preview iframe active)\n  - 2 HTTP reverse proxy chains route through Traefik to container backends\n\n@docs Url, SessionUuid, PreviewPort, AgentChatPort, PreviewProxyPort, AgentChatProxyPort, Bytes, Timestamp\n\n","unions":[{"name":"AgentChatPort","comment":" Port where the MCP sidecar (agent chat backend) listens.\nDerived from preview port: `previewPort + 1000`.\n","args":[],"cases":[["AgentChatPort",["Basics.Int"]]]},{"name":"AgentChatProxyPort","comment":" Port where the agent chat reverse proxy listens (e.g., 24000).\nDerived from agent chat port + offset (default 20000).\n","args":[],"cases":[["AgentChatProxyPort",["Basics.Int"]]]},{"name":"Bytes","comment":" Opaque binary data — PTY I/O, file upload/download chunks.\nNot JSON-encoded; sent as WebSocket binary frames.\n","args":[],"cases":[["Bytes",[]]]},{"name":"PreviewPort","comment":" Port number for the preview dev server.\nReceived via `StatusPayload.previewPort` on the PTY WebSocket.\n","args":[],"cases":[["PreviewPort",["Basics.Int"]]]},{"name":"PreviewProxyPort","comment":" Port where the preview reverse proxy listens (e.g., 23000).\nDerived from preview port + offset (default 20000).\n","args":[],"cases":[["PreviewProxyPort",["Basics.Int"]]]},{"name":"SessionUuid","comment":" Session identifier — each terminal-ui instance gets a unique UUID.\n","args":[],"cases":[["SessionUuid",["String.String"]]]},{"name":"Timestamp","comment":" Millisecond timestamp from `Date.now()`.\nUsed by inject.js and terminal-ui for telemetry timing.\n","args":[],"cases":[["Timestamp",["Basics.Int"]]]},{"name":"Url","comment":" URL string wrapper. Prevents mixing with other strings.\n","args":[],"cases":[["Url",["String.String"]]]}],"aliases":[],"values":[],"binops":[]},{"name":"HttpProxy","comment":" HTTP Proxy Architecture — port derivation and readiness probing.\n\nTwo reverse proxy chains sit between browser and backend apps:\n\n    Preview:     Browser → Traefik :23000 → agent-reverse-proxy :23000 → User app :3000\n    Agent Chat:  Browser → Traefik :24000 → swe-swe-server      :24000 → MCP sidecar :4000\n\nPreview proxy: `npx @choonkeat/agent-reverse-proxy`, launched as an MCP tool\nby the AI agent. Injects debug scripts into HTML, provides DebugHub\nWebSocket endpoints, serves the shell page.\n\nAgent Chat proxy: built into swe-swe-server (`handleProxyRequest`).\nSimple HTTP forwarding with cookie Domain/Secure stripping and CORS\nheaders. No HTML injection or debug scripts.\n\nBoth proxies set `X-Agent-Reverse-Proxy` on every response (including 502),\nso browser probes can distinguish \"proxy up\" from \"Traefik 502.\"\n\nPort derivation (default offset = 20000):\n\n    previewProxyPort   = offset + previewPort          (e.g., 23000)\n    agentChatPort      = previewPort + 1000            (e.g., 4000)\n    agentChatProxyPort = offset + agentChatPort        (e.g., 24000)\n\n@docs PortOffset, previewProxyPort, agentChatPort, agentChatProxyPort\n@docs ProbeResult, classifyProbe, PlaceholderDismiss\n\n","unions":[{"name":"PlaceholderDismiss","comment":" How a placeholder overlay gets dismissed after probe succeeds.\n\nBoth panels show a placeholder (\"Connecting to preview/chat...\") over the\niframe while probing. After probe success, `iframe.src` is set and the\nplaceholder waits for a dismissal event.\n\nPreview has two paths; Agent Chat has one:\n\n    Preview:      DebugWebSocket (urlchange | init)  — primary\n                  IframeOnLoad                       — fallback\n\n    Agent Chat:   IframeOnLoad                       — only path\n\nPlaceholder CSS: both share `.terminal-ui__iframe-placeholder`.\nPreview scopes to `.terminal-ui__iframe-container .terminal-ui__iframe-placeholder`.\nAgent Chat uses `.terminal-ui__agent-chat-placeholder`.\n\n","args":[],"cases":[["DebugWebSocket",[]],["IframeOnLoad",[]]]},{"name":"PortOffset","comment":" Offset added to app ports to derive proxy ports.\nDefault: 20000. Configurable via `swe-swe init --proxy-port-offset`.\n","args":[],"cases":[["PortOffset",["Basics.Int"]]]},{"name":"ProbeResult","comment":" What a probe response tells us about the proxy chain.\n\nThe browser calls `probeUntilReady(url, { method: 'GET', ... })` — uses GET\n(not the default HEAD) to avoid an iOS Safari CORS preflight bug.\nRetries up to 10 times with exponential backoff (2 s → 30 s).\nOn each response, checks `resp.headers.has('X-Agent-Reverse-Proxy')`.\n\n","args":[],"cases":[["ProxyReady",[]],["TraefikDirect",[]]]}],"aliases":[],"values":[{"name":"agentChatPort","comment":" Agent chat app port = preview port + 1000.\n\n    agentChatPort (PreviewPort 3000) == AgentChatPort 4000\n\n","type":"Domain.PreviewPort -> Domain.AgentChatPort"},{"name":"agentChatProxyPort","comment":" Agent chat proxy port = offset + agent chat app port.\n\n    agentChatProxyPort { offset = PortOffset 20000, appPort = AgentChatPort 4000 }\n        == AgentChatProxyPort 24000\n\n","type":"{ offset : HttpProxy.PortOffset, appPort : Domain.AgentChatPort } -> Domain.AgentChatProxyPort"},{"name":"classifyProbe","comment":" Classify a probe response by the presence of `X-Agent-Reverse-Proxy`.\n","type":"{ hasReverseProxyHeader : Basics.Bool } -> HttpProxy.ProbeResult"},{"name":"previewProxyPort","comment":" Preview proxy port = offset + preview app port.\n\n    previewProxyPort { offset = PortOffset 20000, appPort = PreviewPort 3000 }\n        == PreviewProxyPort 23000\n\n","type":"{ offset : HttpProxy.PortOffset, appPort : Domain.PreviewPort } -> Domain.PreviewProxyPort"}],"binops":[]},{"name":"PreviewIframe","comment":" Preview iframe — the shell page and inject.js inside the Preview tab.\n\nTwo processes connect via WS 5,6:\n\n  - **shell page** (`shellPageHTML`) — outer wrapper managing back/forward nav\n  - **inject.js** (`debugInjectJS`) — injected into every proxied HTML page\n\nEndpoint: `/__agent-reverse-proxy-debug__/ws` on agent-reverse-proxy.\n\nEach client sends and receives only its own message types:\n\n  - Shell page sends `ShellPageDebugMsg`, receives `ShellPageCommand`\n  - inject.js sends `InjectJsDebugMsg`, receives `InjectCommand`\n\n@docs ShellPageEffect, onPageLoad, onUrlChange, onNavStateChange\n@docs ShellPageAction, onShellCommand\n@docs InjectEffect, onConsole, onError, onRejection, onFetch, onXhr, onWsUpgrade\n@docs InjectAction, onInjectCommand\n\n","unions":[{"name":"InjectAction","comment":" Actions inject.js takes when it receives a command from the hub.\n","args":[],"cases":[["RunQuery",["{ id : String.String, selector : String.String }"]]]},{"name":"InjectEffect","comment":" Effects produced by inject.js — sends telemetry messages to the hub.\n","args":[],"cases":[["InjectSend",["DebugProtocol.InjectJsDebugMsg"]]]},{"name":"ShellPageAction","comment":" Actions the shell page takes when it receives a command from the hub.\n","args":[],"cases":[["NavigateIframe",["DebugProtocol.NavigateAction"]],["ReloadIframe",[]]]},{"name":"ShellPageEffect","comment":" Effects produced by the shell page — sends navigation messages to the hub.\n","args":[],"cases":[["ShellSend",["DebugProtocol.ShellPageDebugMsg"]]]}],"aliases":[],"values":[{"name":"onConsole","comment":" Captured console output (log/warn/error/info/debug).\n","type":"{ m : String.String, args : List.List String.String, ts : Domain.Timestamp } -> PreviewIframe.InjectEffect"},{"name":"onError","comment":" Uncaught error.\n","type":"{ msg : String.String, file : String.String, line : Basics.Int, col : Basics.Int, stack : Maybe.Maybe String.String, ts : Domain.Timestamp } -> PreviewIframe.InjectEffect"},{"name":"onFetch","comment":" Fetch request/response info.\n","type":"DebugProtocol.HttpResult -> PreviewIframe.InjectEffect"},{"name":"onInjectCommand","comment":" Handle a command from the hub on WS 6.\n","type":"DebugProtocol.InjectCommand -> PreviewIframe.InjectAction"},{"name":"onNavStateChange","comment":" On navigation state change, sends `NavState` with back/forward availability.\n","type":"{ canGoBack : Basics.Bool, canGoForward : Basics.Bool } -> PreviewIframe.ShellPageEffect"},{"name":"onPageLoad","comment":" On page load, the shell page sends an `Init` message with the current URL.\n","type":"{ url : Domain.Url, now : Domain.Timestamp } -> PreviewIframe.ShellPageEffect"},{"name":"onRejection","comment":" Unhandled promise rejection.\n","type":"{ reason : String.String, ts : Domain.Timestamp } -> PreviewIframe.InjectEffect"},{"name":"onShellCommand","comment":" Handle a command from the hub on WS 5.\n","type":"DebugProtocol.ShellPageCommand -> PreviewIframe.ShellPageAction"},{"name":"onUrlChange","comment":" On URL change (pushState/popstate/hashchange), sends `UrlChange`.\n","type":"{ url : Domain.Url, now : Domain.Timestamp } -> PreviewIframe.ShellPageEffect"},{"name":"onWsUpgrade","comment":" Notification that a `ws://` URL was auto-upgraded to `wss://`.\n","type":"{ from : Domain.Url, to : Domain.Url, ts : Domain.Timestamp } -> PreviewIframe.InjectEffect"},{"name":"onXhr","comment":" XMLHttpRequest info.\n","type":"DebugProtocol.HttpResult -> PreviewIframe.InjectEffect"}],"binops":[]},{"name":"PtyProtocol","comment":" WS 1,2 — PTY WebSocket protocol.\n\nEndpoint: `/ws/{uuid}` on swe-swe-server (:3000).\nOne connection per terminal-ui instance, unique UUID.\n\n    terminal-ui #1 (Agent Terminal) <-> swe-swe-server  via /ws/{uuid1}\n    terminal-ui #2 (Terminal)       <-> swe-swe-server  via /ws/{uuid2}\n\nCarries: binary PTY data (xterm I/O) + JSON control messages.\n\n@docs ClientMsg, ServerMsg, StatusPayload, ExitPayload, FileUploadResult\n\n","unions":[{"name":"ClientMsg","comment":" Messages sent by terminal-ui to swe-swe-server.\nBinary messages carry raw PTY input; JSON messages carry control commands.\n","args":[],"cases":[["PtyInput",["Domain.Bytes"]],["Resize",["{ cols : Basics.Int, rows : Basics.Int }"]],["FileUpload",["{ filename : String.String, data : Domain.Bytes }"]],["Ping",[]],["RenameSession",["{ name : String.String }"]],["ToggleYolo",[]],["Chat",["{ text : String.String }"]]]},{"name":"ServerMsg","comment":" Messages received by terminal-ui from swe-swe-server.\nThe `Status` message is critical — its `previewPort` triggers\n`connectDebugWebSocket()`, opening WS 3/4 to the agent-reverse-proxy.\n","args":[],"cases":[["PtyOutput",["Domain.Bytes"]],["Pong",[]],["Status",["PtyProtocol.StatusPayload"]],["ChatMsg",["{ userName : String.String, text : String.String, timestamp : String.String }"]],["FileUploaded",["PtyProtocol.FileUploadResult"]],["Exit",["PtyProtocol.ExitPayload"]]]}],"aliases":[{"name":"ExitPayload","comment":" Exit message payload — exit code plus optional worktree info.\n","args":[],"type":"{ exitCode : Basics.Int, worktree : Maybe.Maybe { path : String.String, branch : String.String, targetBranch : String.String } }"},{"name":"FileUploadResult","comment":" Result of a file upload — success with filename or failure with error.\n","args":[],"type":"{ filename : String.String, result : Result.Result { error : String.String } {} }"},{"name":"StatusPayload","comment":" Payload of the `status` JSON message.\nDelivered periodically by swe-swe-server.\n`ports.preview` triggers the debug WebSocket connection to agent-reverse-proxy.\n","args":[],"type":"{ ports : { preview : Domain.PreviewPort, agentChat : Maybe.Maybe Domain.AgentChatPort }, terminal : { cols : Basics.Int, rows : Basics.Int }, session : { name : String.String, uuidShort : String.String, workDir : String.String, assistant : String.String, viewers : Basics.Int }, features : { yoloMode : Basics.Bool, yoloSupported : Basics.Bool } }"}],"values":[],"binops":[]},{"name":"TerminalUi","comment":" terminal-ui — custom web component mounted in the browser.\n\nTwo instances are active simultaneously:\n\n  - **#1** Agent Terminal (assistant session)\n  - **#2** Terminal (shell session)\n\nEach instance opens TWO WebSocket connections:\n\n    this.ws       -> WS 1/2  /ws/{uuid}        -> swe-swe-server     (PTY)\n    this._debugWs -> WS 3/4  /.../debug.../ui   -> agent-reverse-proxy (preview)\n\nTotal: 4 WebSockets from 2 terminal-ui instances.\n\n@docs State, Connection, Effect\n@docs onPtyMessage, onDebugMessage\n\n","unions":[{"name":"Connection","comment":" The two WebSocket connections each terminal-ui instance maintains.\n","args":[],"cases":[["PtyWs",["Domain.SessionUuid"]],["DebugUiWs",["Domain.PreviewPort"]]]},{"name":"Effect","comment":" Side effects produced by terminal-ui message handlers.\n","args":[],"cases":[["SendPty",["PtyProtocol.ClientMsg"]],["SendDebug",["DebugProtocol.UiCommand"]],["UpdateUrlBar",["Domain.Url"]],["EnableBackButton",["Basics.Bool"]],["EnableForwardButton",["Basics.Bool"]],["OpenIframePane",["{ pane : String.String, url : Domain.Url }"]],["ConfirmExternalUrl",["Domain.Url"]],["ConnectDebugWebSocket",["Domain.PreviewPort"]]]}],"aliases":[{"name":"State","comment":" Per-instance state of a terminal-ui component.\n","args":[],"type":"{ session : { uuid : Domain.SessionUuid, name : String.String, workDir : String.String, assistant : String.String, viewers : Basics.Int }, preview : { port_ : Maybe.Maybe Domain.PreviewPort, agentChatPort : Maybe.Maybe Domain.AgentChatPort, url : Maybe.Maybe Domain.Url, canGoBack : Basics.Bool, canGoForward : Basics.Bool }, features : { yoloMode : Basics.Bool, yoloSupported : Basics.Bool } }"}],"values":[{"name":"onDebugMessage","comment":" Handle a message from the Debug UI WebSocket (WS 3/4).\n\nOnly 4 message types are actually acted on by terminal-ui:\n`UrlChange`, `Init`, `NavState`, and `Open`.\nThe rest (`Console`, `Error`, `Fetch`, etc.) are ignored here —\nthey are consumed by MCP tools via in-process subscribers.\n\n**BUG:** `Open` is broadcast to ALL UI observers by DebugHub.\nWith 2 terminal-ui instances, both receive the message,\nboth call `openIframePane -> setPreviewURL -> confirm()`.\nResult: 2x \"Open in new tab?\" dialogs for external URLs.\n\n","type":"{ msg : DebugProtocol.AllDebugMsg, state : TerminalUi.State } -> ( TerminalUi.State, List.List TerminalUi.Effect )"},{"name":"onPtyMessage","comment":" Handle a message from the PTY WebSocket (WS 1/2).\nThe `Status` message delivers `previewPort`, triggering the debug WS connection.\n","type":"{ msg : PtyProtocol.ServerMsg, state : TerminalUi.State } -> ( TerminalUi.State, List.List TerminalUi.Effect )"}],"binops":[]},{"name":"Topology","comment":" System topology — all processes, connections, and message flows.\n\nEnumerates every WebSocket and HTTP endpoint when 2 terminal-ui\ninstances + Preview tab are active.\n\n    WebSocket Topology\n\n    Browser\n    +==========================================================+\n    |                                                          |\n    |  Agent Terminal     Terminal          Preview tab        |\n    |  terminal-ui #1    terminal-ui #2    shell page          |\n    |  ws + _debugWs     ws + _debugWs     inject.js           |\n    |   |       |         |       |         |       |          |\n    |  WS1    WS3       WS2    WS4       WS5     WS6           |\n    |   |       |         |       |         |       |          |\n    +===|=======|=========|=======|=========|=======|==========+\n        |       |         |       |         |       |\n    +===|=======|=========|=======|=========|=======|==========+\n    |   v       v         v       v         v       v          |\n    |  +--------+   +---------------------------------------+  |\n    |  | swe-   |   |       agent-reverse-proxy             |  |\n    |  | swe-   |   |  +---------------------------------+  |  |\n    |  | server |   |  |           DebugHub              |  |  |\n    |  | :3000  |   |  |  UI obs    <-- WS3, WS4         |  |  |\n    |  |        |   |  |  iframe    <-- WS5, WS6         |  |  |\n    |  |        |   |  |  GET/open  <-- HTTP             |  |  |\n    |  +--------+   |  +---------------------------------+  |  |\n    |               +---------------------------------------+  |\n    |                                                          |\n    |               +----------------+                         |\n    |               | swe-swe-open   |--- HTTP /open --->      |\n    |               | (CLI shim)     |                         |\n    |               +----------------+               Container |\n    +==========================================================+\n\n    HTTP Proxy Chains (port-based, via Traefik)\n\n    Browser           Traefik              Container proxy            Container backend\n                    (forwardauth)\n    terminal-ui  →  :23000  ──────→  agent-reverse-proxy :23000  →  User app :3000\n    terminal-ui  →  :24000  ──────→  swe-swe-server      :24000  →  MCP sidecar :4000\n\n    Traefik creates per-port entrypoints (20 preview + 20 agent chat = 40 ports).\n    Each router applies forwardauth middleware for session cookie validation.\n\nNote: agent-reverse-proxy also exposes a vestigial\n`/__agent-reverse-proxy-debug__/agent` WS endpoint.\nIt is unused — swe-swe-server uses in-process subscribers instead.\n\n@docs Process, TerminalUi, ShellPage, InjectJs, SweServer, AgentReverseProxy\n@docs Traefik, OpenShim, UserApp, McpSidecar\n@docs WebSocketChannel, OpenEndpointHttp, PreviewProxyChain, AgentChatProxyChain\n@docs fullTopology\n\n","unions":[{"name":"AgentReverseProxy","comment":" The agent-reverse-proxy process (debug/preview proxy).\n","args":[],"cases":[["AgentReverseProxy",[]]]},{"name":"InjectJs","comment":" inject.js — injected into every proxied HTML page, captures telemetry (WS 6).\n","args":[],"cases":[["InjectJs",[]]]},{"name":"McpSidecar","comment":" MCP sidecar process — agent chat backend on port `previewPort + 1000`.\n","args":[],"cases":[["McpSidecar",[]]]},{"name":"OpenShim","comment":" swe-swe-open — CLI shim that sends `HTTP GET /open?url=...` to agent-reverse-proxy.\n","args":[],"cases":[["OpenShim",[]]]},{"name":"Process","comment":" A process in the system — wraps all specific process types.\nLocation prefix (Browser/Container/Host) mirrors fullTopology nesting.\n","args":[],"cases":[["BrowserTerminalUi",["Topology.TerminalUi"]],["BrowserShellPage",["Topology.ShellPage"]],["BrowserInjectJs",["Topology.InjectJs"]],["ContainerSweServer",["Topology.SweServer"]],["ContainerAgentReverseProxy",["Topology.AgentReverseProxy"]],["ContainerOpenShim",["Topology.OpenShim"]],["ContainerUserApp",["Topology.UserApp"]],["ContainerMcpSidecar",["Topology.McpSidecar"]],["HostTraefik",["Topology.Traefik"]]]},{"name":"ShellPage","comment":" Shell page — outer wrapper in Preview iframe, manages navigation (WS 5).\n","args":[],"cases":[["ShellPage",[]]]},{"name":"SweServer","comment":" The swe-swe-server process (PTY host, port 3000).\n","args":[],"cases":[["SweServer",[]]]},{"name":"TerminalUi","comment":" A terminal-ui web component instance in the browser.\n","args":[],"cases":[["TerminalUi",["{ label : String.String, sessionUuid : Domain.SessionUuid }"]]]},{"name":"Traefik","comment":" Traefik — host-level reverse proxy providing port-based routing and forwardauth.\n","args":[],"cases":[["Traefik",[]]]},{"name":"UserApp","comment":" The user's application process (e.g., a dev server on port 3000).\n","args":[],"cases":[["UserApp",[]]]},{"name":"WebSocketChannel","comment":" A WebSocket channel between two processes.\n\nAll type parameters are phantom — they exist only at the type level\nto document which processes and message types are valid for each channel.\n\n\n    ptyAgentTerminal :\n        WebSocketChannel\n            SweServer\n            -- server\n            PtyProtocol.ServerMsg\n            -- serverMsg\n            TerminalUi\n            -- client\n            PtyProtocol.ClientMsg\n\n    -- clientMsg\n\n","args":["server","serverMsg","client","clientMsg"],"cases":[["WebSocketChannel",[]]]}],"aliases":[{"name":"AgentChatProxyChain","comment":" Agent Chat proxy chain: Browser → Traefik → swe-swe-server → MCP sidecar.\n\nBuilt into swe-swe-server (`handleProxyRequest`).\nCookie stripping + CORS headers, no HTML injection.\n\n","args":[],"type":"{ listenPort : Domain.AgentChatProxyPort, appPort : Domain.AgentChatPort }"},{"name":"OpenEndpointHttp","comment":" An HTTP endpoint exposed by a process.\n","args":[],"type":"{ method : String.String, path : String.String }"},{"name":"PreviewProxyChain","comment":" Preview proxy chain: Browser → Traefik → agent-reverse-proxy → User app.\n\nSeparate process (`npx @choonkeat/agent-reverse-proxy`).\nInjects debug scripts, provides DebugHub, serves shell page.\n\n","args":[],"type":"{ listenPort : Domain.PreviewProxyPort, appPort : Domain.PreviewPort }"}],"values":[{"name":"fullTopology","comment":" Full topology with 2 terminals + preview active.\n6 WebSockets + 1 HTTP endpoint + 2 HTTP reverse proxy chains.\n","type":"{ browser : { agentTerminal : Topology.TerminalUi, terminal : Topology.TerminalUi, shellPage : Topology.ShellPage, injectJs : Topology.InjectJs }, container : { sweServer : Topology.SweServer, agentReverseProxy : Topology.AgentReverseProxy, openShim : Topology.OpenShim, userApp : Topology.UserApp, mcpSidecar : Topology.McpSidecar }, host : { traefik : Topology.Traefik }, channels : { ptyAgentTerminal : Topology.WebSocketChannel Topology.SweServer PtyProtocol.ServerMsg Topology.TerminalUi PtyProtocol.ClientMsg, ptyTerminal : Topology.WebSocketChannel Topology.SweServer PtyProtocol.ServerMsg Topology.TerminalUi PtyProtocol.ClientMsg, debugUiAgentTerminal : Topology.WebSocketChannel Topology.AgentReverseProxy DebugProtocol.AllDebugMsg Topology.TerminalUi DebugProtocol.UiCommand, debugUiTerminal : Topology.WebSocketChannel Topology.AgentReverseProxy DebugProtocol.AllDebugMsg Topology.TerminalUi DebugProtocol.UiCommand, debugIframeShellPage : Topology.WebSocketChannel Topology.AgentReverseProxy DebugProtocol.ShellPageCommand Topology.ShellPage DebugProtocol.ShellPageDebugMsg, debugIframeInjectJs : Topology.WebSocketChannel Topology.AgentReverseProxy DebugProtocol.InjectCommand Topology.InjectJs DebugProtocol.InjectJsDebugMsg }, openEndpoint : Topology.OpenEndpointHttp, previewProxy : Topology.PreviewProxyChain, agentChatProxy : Topology.AgentChatProxyChain }"}],"binops":[]}]