# Docker Build Certificate Fix

**Date**: 2026-01-03
**Status**: Planning
**Goal**: Fix Docker build failure when enterprise certificates are present

---

## Problem Statement

When running `swe-swe up` on machines with enterprise certificates (NODE_EXTRA_CA_CERTS, SSL_CERT_FILE env vars), the Docker build fails during Node.js installation:

```
curl: (60) SSL certificate problem: self-signed certificate in certificate chain
```

**Error location**: Dockerfile line 28 (NodeSource setup script)

```
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*
```

**Reproduction**: See `bug.txt` for full error transcript.

---

## Root Cause Analysis

### What Works (Init Phase)
1. ✓ `swe-swe init` detects `NODE_EXTRA_CA_CERTS`, `SSL_CERT_FILE`, `NODE_EXTRA_CA_CERTS_BUNDLE` env vars
2. ✓ Copies certificates to `~/.swe-swe/projects/<hash>/certs/`
3. ✓ Creates `.env` file with certificate configuration

### What Fails (Build Phase)
1. ✗ Dockerfile is generated **before** certificates are detected
2. ✗ `swe-swe up` filters OUT certificate env vars from docker-compose (main.go:148-157) to prevent host paths leaking into containers
3. ✗ Docker build runs **before** volumes are mounted
4. ✗ At BUILD TIME, curl has no enterprise certificates to verify SSL
5. ✗ Dockerfile comment (lines 118-120) mentions entrypoint.sh installs certs, but that's RUNTIME - too late for curl commands

### Key Insight
The Dockerfile is **templated** and generated by `swe-swe init`, so it can conditionally include certificate installation based on whether certificates were detected during init.

---

## Solution Design

**Reorder and refactor to detect certificates BEFORE processing Dockerfile template**:

1. Detect certificates early in `handleInit()`
2. Conditionally include certificate installation block in Dockerfile
3. Block runs at BUILD TIME, before Node.js curl commands
4. System trust store is configured, subsequent curl commands verify SSL successfully

---

## Implementation Plan

### Phase 1: Refactor Certificate Detection + Add Test Variants

**What will be achieved**
- `handleCertificates()` returns a boolean indicating if any of NODE_EXTRA_CA_CERTS, SSL_CERT_FILE, or NODE_EXTRA_CA_CERTS_BUNDLE were found
- `processDockerfileTemplate()` accepts `hasCerts` parameter and handles `{{IF CERTS}}` condition
- Test variants added for certificate scenarios
- Golden test files updated with baseline (before functional implementation)

**Small steps to take**
1. Update `handleCertificates()` return type from void to `bool` (cmd/swe-swe/main.go:999)
   - Return `true` if `len(certPaths) > 0`
   - Return `false` in early-exit warning paths

2. Update `processDockerfileTemplate()` signature (cmd/swe-swe/main.go:494)
   - Add `hasCerts bool` parameter (between `withDocker` and `slashCommands`)
   - Add `case "CERTS": skip = !hasCerts` in the switch statement (around line 550)
   - Update function documentation

3. Update call in `handleInit()` to pass `false` for now (line ~913)
   - Will be properly wired in Phase 3

4. Add test variants in `cmd/swe-swe/main_test.go`:
   - Test with `NODE_EXTRA_CA_CERTS` set to a valid cert file
   - Test with `SSL_CERT_FILE` set to a valid cert file
   - Test with no certificates (existing behavior)
   - Create temporary test certificate files for these tests

5. Run `make build golden-update`
   - Captures all test variants in golden files
   - This is the **baseline commit** - shows parameter plumbing working

**How we'll verify**
1. `make test` → all pass
2. `make build golden-update` → generates golden files with test variants
3. `git diff cmd/swe-swe/testdata/golden/` → shows new test cases captured
4. Verify Dockerfiles are identical in all variants (CERTS block not active yet, so `hasCerts` parameter doesn't affect output)

**Commit message**: Refactor: add hasCerts parameter to Dockerfile template processing

---

### Phase 2: Update Dockerfile Template with CERTS Block

**What will be achieved**
- Dockerfile template includes a new `{{IF CERTS}}...{{ENDIF}}` block that installs enterprise certificates at build time
- Block executes before Node.js installation, ensuring curl commands can verify SSL certificates
- Block handles multiple certificate files and properly installs them into the system trust store
- When `hasCerts=false`, the block is removed from generated Dockerfile (no changes to current behavior)
- Verified end-to-end: actual Docker build succeeds with the generated Dockerfile

**Small steps to take**
1. Edit `cmd/swe-swe/templates/host/Dockerfile`
   - Locate line 26 (before `# {{IF NODEJS}}`)
   - Insert the CERTS block here

2. Add the CERTS conditional block (before Node.js installation):
```dockerfile
# {{IF CERTS}}
# Install enterprise certificates early (before curl commands that need SSL verification)
COPY certs/ /tmp/enterprise-certs/
RUN mkdir -p /usr/local/share/ca-certificates && \
    for cert in /tmp/enterprise-certs/*; do \
      cp "$cert" "/usr/local/share/ca-certificates/$(basename "$cert").crt"; \
    done && \
    update-ca-certificates && \
    rm -rf /tmp/enterprise-certs
# {{ENDIF}}
```

   **Why this approach:**
   - `COPY certs/` brings all copied certificate files into the container
   - Loop renames all files with `.crt` extension (required by `update-ca-certificates`)
   - Works regardless of original certificate filename (.pem, .cert, etc.)
   - `update-ca-certificates` installs certs into system trust store
   - Subsequent curl/wget/npm commands automatically trust the certificates
   - Cleanup removes temporary files to keep image size minimal

3. Run `make build golden-update`

**How we'll verify**
1. `make build` → compiles successfully
2. `make golden-update` → regenerates golden files
3. `git diff cmd/swe-swe/testdata/golden/` → shows CERTS block included in with-cert test variants, absent in no-cert variants
4. **End-to-end verification with actual Docker build**:
   - `./dist/swe-swe.darwin-arm64 init --project-directory=~/git/choonkeat/tiny-form-fields --previous-init-flags=reuse`
   - `./dist/swe-swe.darwin-arm64 build --project-directory=~/git/choonkeat/tiny-form-fields swe-swe`
   - Verify Docker build completes successfully and Dockerfile syntax is valid

**Commit message**: feat: add CERTS block to Dockerfile template for enterprise certificate support

---

### Phase 3: Reorder Init Logic and Wire Up hasCerts Parameter

**What will be achieved**
- Certificate detection happens **before** Dockerfile template processing (not after)
- The `hasCerts` boolean returned from `handleCertificates()` is passed to `processDockerfileTemplate()`
- When certificates exist, the Dockerfile includes the CERTS block
- When no certificates exist, the Dockerfile is generated as before (no CERTS block)
- The functional behavior now depends on actual certificate detection during init

**Small steps to take**
1. In `handleInit()` (around line 905-977), identify the current order:
   - Currently: Dockerfile processing happens first (line 912-914)
   - Currently: `handleCertificates()` called later (line 977)

2. Move certificate handling **before** Dockerfile processing:
   - Move the `handleCertificates(sweDir, certsDir)` call to run right after directories are created (after line 827)
   - Capture the return value: `hasCerts := handleCertificates(sweDir, certsDir)`

3. Update the `processDockerfileTemplate()` call (line 913):
   - Change from: `content = []byte(processDockerfileTemplate(string(content), agents, aptPkgs, npmPkgs, *withDocker, slashCmds))`
   - Change to: `content = []byte(processDockerfileTemplate(string(content), agents, aptPkgs, npmPkgs, *withDocker, hasCerts, slashCmds))`

4. Remove the old `handleCertificates()` call at line 977 (it's now earlier)

5. Update the `InitConfig` struct if needed (check if we should persist `HasCerts` info)
   - Likely not needed since certificates are already copied to disk and will be detected on re-init

**How we'll verify**
1. `make test` → all tests pass
2. `make build golden-update` → golden files regenerated
3. `git diff cmd/swe-swe/testdata/golden/` →
   - Test variants WITH certificates now show CERTS block in Dockerfile
   - Test variants WITHOUT certificates show no CERTS block (original behavior)
4. **End-to-end with actual certificates**:
   - `./dist/swe-swe.darwin-arm64 init --project-directory=~/git/choonkeat/tiny-form-fields --previous-init-flags=reuse`
   - `./dist/swe-swe.darwin-arm64 build --project-directory=~/git/choonkeat/tiny-form-fields swe-swe`
   - Verify Docker build succeeds (Dockerfile now has CERTS block with proper cert installation)

**Commit message**: fix: reorder certificate detection before Dockerfile template processing to enable conditional CERTS block

---

### Phase 4: Comprehensive Test & Regression Verification

**What will be achieved**
- All unit tests pass (no regressions from refactoring)
- Golden test files show correct behavior in all scenarios (with certs, without certs)
- Original bug scenario is verified as fixed (Docker build succeeds with enterprise certificates)
- No test artifacts are left behind
- Dockerfile generation is correct in all combinations of flags

**Small steps to take**
1. Run full test suite:
   - `make test` → verify all tests pass (including new certificate test variants)
   - Review test output to ensure no failures or warnings

2. Run golden file validation:
   - `make golden-update` (if needed from Phase 3)
   - `git status cmd/swe-swe/testdata/golden/` → verify golden files are clean
   - Review a few golden file diffs to spot-check CERTS block is present/absent correctly

3. Comprehensive scenario testing:
   - **Scenario A (no certs)**: Verify Dockerfile generation is unchanged from before
     - `./dist/swe-swe.darwin-arm64 init --project-directory=/tmp/test-no-certs`
     - Inspect generated Dockerfile at `~/.swe-swe/projects/*/Dockerfile`
     - Verify: No CERTS block is present (identical to current behavior before this fix)
     - Verify: Dockerfile is identical to what would be generated on a machine without enterprise certs
     - ✓ Code logic verified: `hasCerts=false` → no CERTS block

   - **Scenario B (with certs - the bug fix)**: Reuse existing project with certs, verify build succeeds
     - `./dist/swe-swe.darwin-arm64 init --project-directory=~/git/choonkeat/tiny-form-fields --previous-init-flags=reuse`
     - `./dist/swe-swe.darwin-arm64 build --project-directory=~/git/choonkeat/tiny-form-fields swe-swe`
     - Verify build succeeds (the original bug from bug.txt is fixed!)
     - Verify: CERTS block is in generated Dockerfile
     - ✓ Code logic verified: `hasCerts=true` → CERTS block included

4. Regression verification:
   - Test with various agent combinations:
     - `--agents=claude` (needs Node.js)
     - `--agents=aider` (needs Python, no Node.js)
     - `--agents=claude,aider` (both)
     - `--exclude-agents=aider,goose`
   - Each should still generate correct Dockerfile without regressions

5. Test artifact cleanup:
   - Remove temporary test directories: `rm -rf /tmp/test-no-certs`

**How we'll verify**
1. **Unit tests**: `make test` → all green ✓
2. **Golden files**: No unexpected diffs in `cmd/swe-swe/testdata/golden/` ✓
3. **No-certs scenario**: Generated Dockerfile has no CERTS block (identical to before-fix behavior) ✓
4. **With-certs scenario**: Docker build succeeds, CERTS block present, Node.js installs successfully ✓
5. **Regression tests**: All agent combinations work, no side effects ✓
6. **Original bug fixed**: The initial `curl` failure from bug.txt no longer occurs ✓

**Summary commit message**: test: verify certificate detection and template processing in all scenarios

---

## Key Files Modified

1. `cmd/swe-swe/main.go`
   - `handleCertificates()` function signature (return type, logic)
   - `processDockerfileTemplate()` function signature (new parameter, condition handling)
   - `handleInit()` function (reorder certificate detection, pass hasCerts parameter)

2. `cmd/swe-swe/templates/host/Dockerfile`
   - Add `{{IF CERTS}}...{{ENDIF}}` block before Node.js installation

3. `cmd/swe-swe/main_test.go`
   - Add test variants for certificate detection scenarios

4. `cmd/swe-swe/testdata/golden/`
   - Golden files updated via `make golden-update`

---

## Expected Outcomes

### Before This Fix
- Machines with enterprise certificates cannot run `swe-swe up` due to curl SSL verification failure
- Error occurs during Docker build, blocking the entire workflow

### After This Fix
- Certificates detected by `swe-swe init` are conditionally included in generated Dockerfile
- Docker build automatically installs certificates before running curl commands
- `swe-swe up` succeeds on machines with enterprise certificates
- Machines without enterprise certificates work as before (no functional change)
- `--previous-init-flags=reuse` correctly regenerates Dockerfile with certificates

---

## Testing Strategy Summary

| Phase | Type | Verification |
|-------|------|--------------|
| 1 | Unit | `make test`, golden files unchanged |
| 2 | Integration | `make build`, golden diffs show CERTS block, Docker build succeeds |
| 3 | Integration | `make test`, golden diffs show CERTS block conditional behavior |
| 4 | End-to-end | All tests pass, both cert/no-cert scenarios work, original bug fixed |

---

## Rollback Plan

If issues arise:
1. Revert Phase 3 commit (stops wiring up the hasCerts parameter)
2. Revert Phase 2 commit (removes CERTS block from template)
3. Revert Phase 1 commit (removes hasCerts parameter)
4. Project returns to original state with original behavior
