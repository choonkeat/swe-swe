# Clickable File Path Links in Terminal

## Goal

Implement clickable file path hyperlinks in swe-swe's xterm UI, shared between both live terminal sessions and recording playback, using xterm.js's `registerLinkProvider` API.

**Click behavior**: Copy path to clipboard + open VS Code at the correct workspace folder.

---

## Phase 1: Server passes workspace path to frontend

### What will be achieved
Add `workDir` to the existing `status` WebSocket message. Frontend stores it for VS Code URL construction.

### Steps

1. **Add `workDir` to `BroadcastStatus`** in `main.go` line ~372:
   ```go
   status := map[string]interface{}{
       "type":        "status",
       // ... existing fields
       "workDir":     s.WorkDir,  // ADD THIS
   }
   ```

2. **Frontend receives and stores `workDir`** in `terminal-ui.js` line ~1399:
   ```javascript
   case 'status':
       // ... existing
       this.workDir = msg.workDir || '';  // ADD THIS
   ```

3. **If `workDir` is empty, default to server cwd** - The server can pass its cwd when `s.WorkDir` is empty

### Verification

1. `make test` - ensure existing tests pass
2. Manual: Console.log `this.workDir` in frontend, verify correct value for regular and worktree sessions

---

## Phase 2: Refactor status bar VS Code link to use shared helper

### What will be achieved
Create a `getVSCodeUrl()` helper function that uses `this.workDir` to construct the correct VS Code URL. Update the status bar link to use this helper.

### Steps

1. **Create `getVSCodeUrl()` method** in `terminal-ui.js`:
   ```javascript
   getVSCodeUrl() {
       const baseUrl = this.getBaseUrl();
       if (this.workDir) {
           return `${baseUrl}/vscode/?folder=${encodeURIComponent(this.workDir)}`;
       }
       return `${baseUrl}/vscode/`;
   }
   ```

2. **Update `renderServiceLinks()`** (line ~1020) to use the helper:
   ```javascript
   const services = [
       { name: 'vscode', url: this.getVSCodeUrl() },
       { name: 'browser', url: `${baseUrl}/chrome/` }
   ];
   ```

3. **Re-render service links when `workDir` changes** - Call `renderServiceLinks()` after receiving `status` message

### Verification

1. `make test` - ensure existing tests pass
2. Manual: Verify VS Code link shows correct `?folder=` param for worktree sessions
3. Click the link - VS Code should open with correct folder

---

## Phase 3: Create link provider using shared helper

### What will be achieved
Create `link-provider.js` with `registerFileLinkProvider(terminal, options)` that detects file paths in terminal output, makes them clickable, and on click: copies path to clipboard + opens VS Code.

### Steps

1. **Create `static/link-provider.js`** with:
   ```javascript
   function registerFileLinkProvider(terminal, options) {
       terminal.registerLinkProvider({
           provideLinks: (bufferLineNumber, callback) => {
               // Get line text, detect file paths, return links
           }
       });
   }
   ```

2. **Implement path detection regex** matching:
   - Absolute: `/workspace/...`, `/home/...`
   - Relative: `./src/...`, `src/foo.go`
   - With line:col: `file.go:123`, `file.go:123:45`
   - Avoid false positives (URLs, common words)

3. **Implement click handler**:
   ```javascript
   activate: (event, text) => {
       navigator.clipboard.writeText(text);
       window.open(options.getVSCodeUrl(), 'swe-swe-vscode');
   }
   ```

4. **Add `<script src="/static/link-provider.js">` to `index.html`**

5. **Call `registerFileLinkProvider()` in `terminal-ui.js`** after terminal init

### Verification

1. `make test` - ensure existing tests pass
2. Manual: `echo "/workspace/src/main.go:42"` - verify clickable, click copies + opens VS Code
3. Edge cases: URLs should NOT link, paths with spaces, deep nesting

---

## Phase 4: Integrate into recording playback

### What will be achieved
Embed `link-provider.js` into the recording playback HTML generated by `render.go`.

### Steps

1. **Embed `link-provider.js` in `render.go`** using Go's embed:
   ```go
   //go:embed static/link-provider.js
   var linkProviderJS string
   ```

2. **Add `LinkProviderJS` to template data** and inline in generated HTML

3. **Call `registerFileLinkProvider()` after xterm init** with WorkDir from recording metadata

4. **Pass `WorkDir` to playback template** from recording metadata

5. **Handle missing WorkDir gracefully** - Old recordings default to `/vscode/`

### Verification

1. `make test` - ensure existing tests pass
2. `make build golden-update` - verify golden files if templates change
3. Manual: View recording with file paths, verify clickable and opens VS Code

---

## Phase 5: End-to-end verification

### What will be achieved
Comprehensive testing using browser MCP.

### Steps

1. **Boot test container** per `/workspace/.swe-swe/test-container-workflow.md`

2. **Test live session - regular workspace**:
   - Start session, run `echo "/workspace/src/main.go:42"`
   - Verify link appears, click copies + opens VS Code
   - Verify status bar VS Code link is `/vscode/`

3. **Test live session - worktree**:
   - Switch to worktree session
   - Verify VS Code link includes `?folder=/workspace/.swe-swe/worktrees/...`

4. **Test recording playback**:
   - View recording with file paths
   - Verify paths clickable, behavior matches live

5. **Test edge cases**:
   - URLs should NOT become file links
   - Paths with special chars
   - Multiple paths on same line

6. **Shutdown test container**

---

## Files to modify

- `cmd/swe-swe/templates/host/swe-swe-server/main.go` - Add workDir to status message
- `cmd/swe-swe/templates/host/swe-swe-server/static/terminal-ui.js` - Store workDir, add getVSCodeUrl(), call link provider
- `cmd/swe-swe/templates/host/swe-swe-server/static/index.html` - Load link-provider.js
- `cmd/swe-swe/templates/host/swe-swe-server/static/link-provider.js` - NEW FILE
- `cmd/swe-swe/templates/host/swe-swe-server/playback/render.go` - Embed and use link provider

## Related tracking

See `tasks/pending-vscode-file-open-query-param.md` for upstream code-server issues that would enable opening specific files directly.
