=== Code-Server UID:GID Fix ===

[STEP 1] Create custom code-server Dockerfile wrapper
Time: $(date +%H%M%S)
Expected: Create /cmd/swe-swe/templates/host/code-server/Dockerfile that:
  - Inherits from codercom/code-server:latest
  - Accepts UID and GID build arguments
  - Recreates coder user/group with those UID:GID values
  - Fixes ownership of /home/coder directory

Status: STARTING
135002

[OBSERVED] $(date +%H%M%S)
Created: /cmd/swe-swe/templates/host/code-server/Dockerfile
Content: Inherits from codercom/code-server:latest
         - ARG UID=1000, ARG GID=1000
         - groupdel coder && groupadd -g ${GID} coder
         - userdel coder && useradd -m -u ${UID} -g ${GID} -s /bin/bash coder
         - chown -R ${UID}:${GID} /home/coder

Status: ✓ STEP 1 COMPLETE
135034

[STEP 2] Update docker-compose.yml to build code-server with UID:GID args
Time: $(date +%H%M%S)
Expected: Replace code-server image with build section containing UID:GID placeholders

[OBSERVED] $(date +%H%M%S)
Changed code-server service from:
  image: codercom/code-server:latest
To:
  build:
    context: code-server
    args:
      UID: {{UID}}
      GID: {{GID}}

Status: ✓ STEP 2 COMPLETE
135213

[STEP 3] Update template processor for docker-compose placeholders
Time: $(date +%H%M%S)
Expected: Extend processSimpleTemplate() to accept and process UID:GID values

[OBSERVED] $(date +%H%M%S)
Changed: processSimpleTemplate() function signature (line 750)
  From: func processSimpleTemplate(content string, withDocker bool, ssl string) string
  To:   func processSimpleTemplate(content string, withDocker bool, ssl string, hostUID int, hostGID int) string

Added: Placeholder processing (lines 781-786):
  if strings.Contains(line, "{{UID}}") {
    line = strings.ReplaceAll(line, "{{UID}}", fmt.Sprintf("%d", hostUID))
  }
  if strings.Contains(line, "{{GID}}") {
    line = strings.ReplaceAll(line, "{{GID}}", fmt.Sprintf("%d", hostGID))
  }

Updated: All call sites to pass hostUID and hostGID:
  - line 1330: processSimpleTemplate for docker-compose.yml
  - line 1335: processSimpleTemplate for traefik-dynamic.yml
  - line 961 in main_test.go: test call

Status: ✓ STEP 3 COMPLETE
142856

[STEP 4] Add code-server/Dockerfile to file list and regenerate golden
Time: $(date +%H%M%S)
Expected: Ensure code-server/Dockerfile is included in init output and golden files

[OBSERVED] $(date +%H%M%S)
Added: "templates/host/code-server/Dockerfile" to hostFiles list (line 1261 in main.go)

Regenerated: All golden test files with:
  - code-server/Dockerfile files created in all test variants
  - docker-compose.yml updated with UID:GID values replaced (501:20 for this system)
  - Example from golden/default/docker-compose.yml:
    code-server:
      build:
        context: code-server
        args:
          UID: 501
          GID: 20

Tests: All tests pass ✓
  - cmd/swe-swe tests: PASS
  - cmd/swe-swe-server tests: PASS
  - Golden files: All regenerated correctly

Status: ✓ STEP 4 COMPLETE
143012

=== Bug Fix 1: User/Group Deletion Order ===

Issue: Initial Docker build failed with:
  Error: groupdel: cannot remove the primary group of user 'coder'
  Reason: Tried to delete group before deleting the user with that group as primary

Fix: Reversed deletion order in code-server/Dockerfile (line 10)
  Changed FROM: groupdel coder && groupadd ... && userdel coder ...
  Changed TO:   userdel coder && groupdel coder && groupadd ... && useradd ...

Logic: User must be deleted first (has group as primary), then group can be deleted

Status: ✓ Fixed, golden files regenerated

=== Bug Fix 2: User In Use During Build ===

Issue: Second Docker build failed with:
  Error: userdel: user coder is currently used by process 1
  Reason: The coder user has running processes during the build

Fix: Added -f (force) flag to userdel in code-server/Dockerfile (line 11)
  Changed FROM: userdel coder && groupdel ...
  Changed TO:   userdel -f coder && groupdel ...

Logic: The -f flag allows deletion even when user has processes running,
       which is safe in the ephemeral Docker build context

Status: ✓ Fixed, golden files regenerated, all tests pass

=== Code-Server UID:GID Fix COMPLETE ===
