FROM oven/bun:alpine

COPY docker/ca-certificates/*.* /usr/local/share/ca-certificates/

RUN set -e; \
    if [ -d /usr/local/share/ca-certificates ] && \
       [ "$(ls -A /usr/local/share/ca-certificates 2>/dev/null)" ]; then \
        for cert in /usr/local/share/ca-certificates/*; do \
            [ -f "$cert" ] || continue; \
            printf '\n' >> /etc/ssl/certs/ca-certificates.crt; \
            cat "$cert"  >> /etc/ssl/certs/ca-certificates.crt; \
        done; \
    fi

# Install git and nodejs (required for cloning and building)
RUN apk add --no-cache git nodejs npm

# Clone the claudia repository
RUN git clone https://github.com/getAsterisk/claudia.git /app

# Set working directory
WORKDIR /app

# Install dependencies
RUN bun install

# Build the application
RUN bun run build

# Expose the default Vite preview port
EXPOSE 4173

# Install a simple HTTP server for serving the built files
RUN npm install -g serve

# Start the built application with serve (no host restrictions)
# The -s flag enables single-page app mode, -l sets the port
CMD ["sh", "-c", "cd /app && serve -s dist -l 4173"]
