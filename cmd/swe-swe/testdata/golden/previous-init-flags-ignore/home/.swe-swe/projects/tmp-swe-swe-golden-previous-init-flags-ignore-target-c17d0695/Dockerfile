# swe-swe development environment
# Based on golang image with Node.js and AI assistant tools
# Generated by: swe-swe init

# Stage 1: Build swe-swe-server from source
FROM golang:1.22-alpine AS server-builder
WORKDIR /build
COPY swe-swe-server/go.mod swe-swe-server/go.sum ./
RUN go mod download
COPY swe-swe-server/*.go ./
COPY swe-swe-server/static/ ./static/
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o swe-swe-server .

# Stage 2: Main development environment
FROM golang:1.23-bookworm

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    ca-certificates \
    jq \
    vim \
    && rm -rf /var/lib/apt/lists/*



# Install Python and pip for AI assistants
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*






# Install aider
RUN pip3 install --break-system-packages aider-chat






# Enterprise certificate support
# swe-swe init detects NODE_EXTRA_CA_CERTS/SSL_CERT_FILE env vars and copies certs
# to .swe-swe/certs/. The entrypoint.sh installs them into the system trust store.

# Copy swe-swe-server binary from builder stage
COPY --from=server-builder /build/swe-swe-server /usr/local/bin/swe-swe-server

# Copy entrypoint script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create non-root user for running swe-swe-server
# If target GID already exists (e.g., dialout=20), use that group; otherwise create app group
RUN if ! getent group 1000 > /dev/null; then groupadd -g 1000 app; fi && \
    useradd -m -u 1000 -g 1000 -s /bin/bash app

# Create worktrees directory with app ownership (used for git worktrees)
RUN mkdir -p /worktrees && chown 1000:1000 /worktrees

# Entrypoint runs as root to install certificates,
# then switches to app user to run swe-swe-server
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Default working directory (entrypoint will cd to /workspace for the server)
WORKDIR /workspace

# Default command: run swe-swe-server pointing to /workspace
CMD ["/usr/local/bin/swe-swe-server", "-working-directory", "/workspace", "-addr", "0.0.0.0:9898"]
