server {
    listen 8081;

    # Use relative paths in Location headers instead of absolute URLs
    # This prevents nginx from using the internal port 8081 in redirects
    absolute_redirect off;

    location /vscode {
        # Redirect /vscode to /vscode/ with trailing slash
        rewrite ^/vscode$ /vscode/ permanent;
    }

    location /vscode/ {
        proxy_pass http://code-server:8080/;

        # Only rewrite path-only Location headers (not absolute URLs)
        # This handles /login -> /vscode/login but leaves absolute URLs untouched
        proxy_redirect ~^/(.*)$ /vscode/$1;

        # Pass necessary headers to code-server
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for code-server
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
