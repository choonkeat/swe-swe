# swe-swe development environment
# Based on golang image with Node.js and AI assistant tools
# Generated by: swe-swe init

# Stage 1: Build swe-swe-server from source
FROM golang:1.23-alpine AS server-builder
WORKDIR /build
COPY swe-swe-server/go.mod swe-swe-server/go.sum ./
RUN go mod download
COPY swe-swe-server/*.go ./
COPY swe-swe-server/static/ ./static/
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o swe-swe-server .

# Stage 2: Main development environment
FROM golang:1.23-bookworm

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    ca-certificates \
    jq \
    unzip \
    vim \
    && rm -rf /var/lib/apt/lists/*


# Install Node.js 24 LTS from NodeSource (Debian repos only have EOL Node.js 18)
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Ensure npm global packages are in PATH
ENV PATH="/usr/local/lib/node_modules/.bin:${PATH}"

# Install Python and pip for AI assistants
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*


# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install Gemini CLI
RUN npm install -g @google/gemini-cli

# Install Codex CLI
RUN npm install -g @openai/codex

# Install MCP Playwright for browser automation
# This enables the system to control browsers via Playwright CDP connections
RUN npm install -g @playwright/mcp

# Install aider
RUN pip3 install --break-system-packages aider-chat

# Install Goose (AI pair programmer from Block)
RUN curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | GOOSE_BIN_DIR=/usr/local/bin CONFIGURE=false bash

# Install OpenCode CLI (https://github.com/anomalyco/opencode)
RUN npm install -g opencode-ai



# Clone slash commands repositories to temp location
# (will be copied to home directory by entrypoint.sh)
RUN git clone --depth 1 https://github.com/choonkeat/slash-commands.git /tmp/slash-commands/ck

# Enterprise certificate support
# swe-swe init detects NODE_EXTRA_CA_CERTS/SSL_CERT_FILE env vars and copies certs
# to .swe-swe/certs/. The entrypoint.sh installs them into the system trust store.

# Copy swe-swe-server binary from builder stage
COPY --from=server-builder /build/swe-swe-server /usr/local/bin/swe-swe-server

# Copy entrypoint script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create non-root user for running swe-swe-server
# If target GID already exists (e.g., dialout=20), use that group; otherwise create app group
RUN if ! getent group 1000 > /dev/null; then groupadd -g 1000 app; fi && \
    useradd -m -u 1000 -g 1000 -s /bin/bash app

# Create worktrees directory with app ownership (used for git worktrees)
RUN mkdir -p /worktrees && chown 1000:1000 /worktrees

# Create repos directory with app ownership (used for cloning external repos)
RUN mkdir -p /repos && chown 1000:1000 /repos

# Entrypoint runs as root to install certificates,
# then switches to app user to run swe-swe-server
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Default working directory (entrypoint will cd to /workspace for the server)
WORKDIR /workspace

# Default command: run swe-swe-server pointing to /workspace
CMD ["/usr/local/bin/swe-swe-server", "-working-directory", "/workspace", "-addr", "0.0.0.0:9898"]
