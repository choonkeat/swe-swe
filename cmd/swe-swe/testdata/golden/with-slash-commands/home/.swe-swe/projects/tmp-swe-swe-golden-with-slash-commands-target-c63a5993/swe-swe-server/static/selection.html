<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>swe-swe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .selection-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
            padding: 24px;
        }
        .selection-page__header {
            text-align: center;
            margin-bottom: 32px;
        }
        .selection-page__title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        .selection-page__subtitle {
            font-size: 14px;
            color: #888;
        }
        .agents-list {
            max-width: 600px;
            width: 100%;
        }
        .agent-group {
            margin-bottom: 24px;
        }
        .agent-group__header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #404040;
        }
        .agent-group__icon {
            font-size: 24px;
        }
        .agent-group__name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        .agent-group__count {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }
        .agent-group__sessions {
            padding-left: 16px;
        }
        .session-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 4px 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            transition: all 0.15s ease;
        }
        .session-item:hover {
            border-color: #007acc;
            background: #333;
        }
        .session-item__uuid {
            font-family: monospace;
            font-size: 14px;
            color: #9cdcfe;
        }
        .session-item__viewers {
            font-size: 12px;
            color: #888;
        }
        .session-item__duration {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }
        .new-session {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin: 4px 0;
            background: transparent;
            border: 1px dashed #404040;
            border-radius: 6px;
            text-decoration: none;
            color: #888;
            transition: all 0.15s ease;
        }
        .new-session:hover {
            border-color: #007acc;
            color: #fff;
            background: #2d2d2d;
        }
        .new-session__icon {
            font-size: 14px;
        }
        .new-session__text {
            font-size: 14px;
        }
        .worktree-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 2px 0 2px 24px;
            background: transparent;
            border: 1px dashed #333;
            border-radius: 6px;
            text-decoration: none;
            color: #666;
            font-size: 13px;
            transition: all 0.15s ease;
        }
        .worktree-link:hover {
            border-color: #007acc;
            color: #9cdcfe;
            background: #2d2d2d;
        }
        .worktree-link__icon {
            font-size: 12px;
        }
        .worktree-link__text {
            font-size: 13px;
        }
        /* Assistant-specific hover colors */
        .agent-group[data-assistant="claude"] .session-item:hover,
        .agent-group[data-assistant="claude"] .new-session:hover,
        .agent-group[data-assistant="claude"] .worktree-link:hover {
            border-color: #d97706;
        }
        .agent-group[data-assistant="gemini"] .session-item:hover,
        .agent-group[data-assistant="gemini"] .new-session:hover,
        .agent-group[data-assistant="gemini"] .worktree-link:hover {
            border-color: #4285f4;
        }
        .agent-group[data-assistant="codex"] .session-item:hover,
        .agent-group[data-assistant="codex"] .new-session:hover,
        .agent-group[data-assistant="codex"] .worktree-link:hover {
            border-color: #10a37f;
        }
        .agent-group[data-assistant="goose"] .session-item:hover,
        .agent-group[data-assistant="goose"] .new-session:hover,
        .agent-group[data-assistant="goose"] .worktree-link:hover {
            border-color: #f472b6;
        }
        .agent-group[data-assistant="aider"] .session-item:hover,
        .agent-group[data-assistant="aider"] .new-session:hover,
        .agent-group[data-assistant="aider"] .worktree-link:hover {
            border-color: #22c55e;
        }
        .agent-group[data-assistant="custom"] .session-item:hover,
        .agent-group[data-assistant="custom"] .new-session:hover,
        .agent-group[data-assistant="custom"] .worktree-link:hover {
            border-color: #a855f7;
        }
        .selection-page__footer {
            margin-top: auto;
            padding-top: 32px;
            text-align: center;
        }
        .ssl-cert-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            color: #888;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .ssl-cert-link:hover {
            color: #fff;
            border-color: #007acc;
            background: #2d2d2d;
        }
        .footer-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            color: #888;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .github-link:hover {
            color: #fff;
            border-color: #007acc;
            background: #2d2d2d;
        }
        .github-link svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .ios-safari-warning {
            display: none;
            max-width: 600px;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 24px;
            background: #442c00;
            border: 1px solid #d97706;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
        }
        .ios-safari-warning__title {
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 4px;
        }
        .ios-safari-warning__text {
            color: #fcd34d;
        }
        .ios-safari-warning a {
            color: #fbbf24;
            text-decoration: underline;
        }
        /* Recording items within agent groups */
        .recording-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 4px 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .recording-item:hover {
            border-color: #6b7280;
            background: #333;
        }
        .recording-item__name {
            font-family: monospace;
            font-size: 14px;
            color: #9cdcfe;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .recording-item__time {
            font-size: 12px;
            color: #888;
        }
        .recording-item__actions {
            display: flex;
            gap: 8px;
        }
        .recording-item__play {
            padding: 4px 8px;
            font-size: 12px;
            color: #9cdcfe;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        .recording-item__play:hover {
            border-color: #007acc;
            background: #2d2d2d;
        }
        .recording-item__delete {
            padding: 4px 8px;
            font-size: 12px;
            color: #888;
            background: none;
            border: 1px solid #404040;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .recording-item__delete:hover {
            color: #ef4444;
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        /* Conflict warning dialog */
        .conflict-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .conflict-dialog {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }
        .conflict-dialog__title {
            font-size: 16px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 12px;
        }
        .conflict-dialog__message {
            font-size: 14px;
            color: #d4d4d4;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .conflict-dialog__type {
            display: inline-block;
            padding: 4px 8px;
            background: #404040;
            border-radius: 4px;
            font-size: 12px;
            color: #9cdcfe;
            margin-bottom: 16px;
        }
        .conflict-dialog__actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .conflict-dialog__btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .conflict-dialog__btn--rename {
            background: transparent;
            border: 1px solid #404040;
            color: #888;
        }
        .conflict-dialog__btn--rename:hover {
            border-color: #007acc;
            color: #fff;
        }
        .conflict-dialog__btn--use {
            background: #d97706;
            border: 1px solid #d97706;
            color: #fff;
        }
        .conflict-dialog__btn--use:hover {
            background: #b45309;
            border-color: #b45309;
        }
    </style>
</head>
<body>
    <!-- Conflict warning dialog -->
    <div class="conflict-dialog-overlay" id="conflict-dialog-overlay">
        <div class="conflict-dialog">
            <div class="conflict-dialog__title">Branch already exists</div>
            <div class="conflict-dialog__type" id="conflict-type"></div>
            <div class="conflict-dialog__message" id="conflict-message"></div>
            <div class="conflict-dialog__actions">
                <button class="conflict-dialog__btn conflict-dialog__btn--rename" id="conflict-rename-btn">Rename</button>
                <button class="conflict-dialog__btn conflict-dialog__btn--use" id="conflict-use-btn">Use existing</button>
            </div>
        </div>
    </div>
    <div class="selection-page">
        <div class="selection-page__header">
            <h1 class="selection-page__title">swe-swe</h1>
            <p class="selection-page__subtitle">Join an existing session or start a new one</p>
        </div>
        <div class="ios-safari-warning" id="ios-safari-warning">
            <div class="ios-safari-warning__title">iOS Safari + Self-Signed Certs</div>
            <div class="ios-safari-warning__text">
                WebSocket connections may not work in Safari with self-signed certificates.
                Please use <strong>Chrome</strong> or another browser on iOS for best results.
            </div>
        </div>
        <div class="agents-list">
            {{range .Agents}}
            <div class="agent-group" data-assistant="{{.Assistant.Binary}}">
                <div class="agent-group__header">
                    <span class="agent-group__icon">{{if eq .Assistant.Binary "claude"}}üß†{{else if eq .Assistant.Binary "gemini"}}‚ú®{{else if eq .Assistant.Binary "codex"}}ü§ñ{{else if eq .Assistant.Binary "goose"}}ü™ø{{else if eq .Assistant.Binary "aider"}}üõ†{{else}}‚öôÔ∏è{{end}}</span>
                    <span class="agent-group__name">{{.Assistant.Name}}</span>
                    {{if or .Sessions .Recordings}}<span class="agent-group__count">{{if .Sessions}}{{len .Sessions}} session{{if gt (len .Sessions) 1}}s{{end}}{{end}}{{if and .Sessions .Recordings}}, {{end}}{{if .Recordings}}{{len .Recordings}} recording{{if gt (len .Recordings) 1}}s{{end}}{{end}}</span>{{end}}
                </div>
                <div class="agent-group__sessions">
                    {{range .Sessions}}
                    <a href="/session/{{.UUID}}?assistant={{.Assistant}}{{if $.Debug}}&debug=1{{end}}" class="session-item">
                        <span class="session-item__uuid">{{if .Name}}{{.Name}} ({{.UUIDShort}}){{else}}{{.UUIDShort}}{{end}}</span>
                        <span class="session-item__viewers">{{.ClientCount}} viewer{{if ne .ClientCount 1}}s{{end}}</span>
                        <span class="session-item__duration">{{.DurationStr}}</span>
                    </a>
                    {{end}}
                    {{range .Recordings}}
                    <div class="recording-item" data-uuid="{{.UUID}}">
                        <span class="recording-item__name">{{if .Name}}{{.Name}}{{else}}session-{{.UUIDShort}}{{end}}</span>
                        <span class="recording-item__time">{{.EndedAgo}}</span>
                        <div class="recording-item__actions">
                            <a href="/recording/{{.UUID}}" class="recording-item__play">View</a>
                            <button class="recording-item__delete" onclick="deleteRecording('{{.UUID}}', this)">Delete</button>
                        </div>
                    </div>
                    {{end}}
                    <a href="#" onclick="startNewSession('{{.Assistant.Binary}}', '{{$.NewUUID}}', {{$.Debug}}); return false;" class="new-session">
                        <span class="new-session__icon">+</span>
                        <span class="new-session__text">Start new session</span>
                    </a>
                </div>
            </div>
            {{end}}
        </div>
        <div class="selection-page__footer">
            <div class="footer-links">
                {{if .HasSSLCert}}
                <a href="/ssl/ca.crt" class="ssl-cert-link">
                    <span>üì±</span>
                    <span>Install SSL Certificate</span>
                </a>
                {{end}}
                <a href="https://github.com/choonkeat/swe-swe" target="_blank" rel="noopener" class="github-link">
                    <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                    <span>GitHub</span>
                </a>
            </div>
        </div>
    </div>
    <script>
        // Detect iOS Safari and show warning for self-signed cert scenarios
        (function() {
            var ua = navigator.userAgent;
            var isIOS = /iPad|iPhone|iPod/.test(ua);
            var isSafari = /Safari/.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/.test(ua);
            var isHTTPS = location.protocol === 'https:';

            if (isIOS && isSafari && isHTTPS) {
                var warning = document.getElementById('ios-safari-warning');
                if (warning) {
                    warning.style.display = 'block';
                }
            }
        })();

        function startNewSession(assistant, sessionUUID, debug) {
            promptForName(assistant, sessionUUID, debug);
        }

        function promptForName(assistant, sessionUUID, debug) {
            var name = prompt('Session name (optional, leave empty for no worktree):');

            // User clicked Cancel
            if (name === null) {
                return;
            }

            // Trim and validate
            name = name.trim();
            if (name.length > 128) {
                name = name.substring(0, 128);
            }

            // If no name provided, proceed directly
            if (name.length === 0) {
                navigateToSession(assistant, sessionUUID, debug, '');
                return;
            }

            // Check for conflicts
            fetch('/api/worktree/check?name=' + encodeURIComponent(name))
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.exists) {
                        showConflictDialog(assistant, sessionUUID, debug, name, data.type, data.branch);
                    } else {
                        navigateToSession(assistant, sessionUUID, debug, name);
                    }
                })
                .catch(function(err) {
                    console.error('Error checking worktree:', err);
                    // Proceed anyway on error
                    navigateToSession(assistant, sessionUUID, debug, name);
                });
        }

        function navigateToSession(assistant, sessionUUID, debug, name) {
            var url = '/session/' + sessionUUID + '?assistant=' + encodeURIComponent(assistant);
            if (debug) {
                url += '&debug=1';
            }
            if (name.length > 0) {
                url += '&name=' + encodeURIComponent(name);
            }
            window.location.href = url;
        }

        function showConflictDialog(assistant, sessionUUID, debug, name, conflictType, branchName) {
            var overlay = document.getElementById('conflict-dialog-overlay');
            var typeEl = document.getElementById('conflict-type');
            var messageEl = document.getElementById('conflict-message');
            var renameBtn = document.getElementById('conflict-rename-btn');
            var useBtn = document.getElementById('conflict-use-btn');

            // Set type label
            var typeLabels = {
                'worktree': 'Existing worktree',
                'local': 'Local branch (no worktree)',
                'remote': 'Remote branch'
            };
            typeEl.textContent = typeLabels[conflictType] || conflictType;

            // Set message
            var messages = {
                'worktree': 'A worktree for "' + branchName + '" already exists. You can enter the existing session or choose a different name.',
                'local': 'Local branch "' + branchName + '" exists. A new worktree will be attached to this branch.',
                'remote': 'Remote branch "origin/' + branchName + '" exists. A new worktree will be created tracking this remote branch.'
            };
            messageEl.textContent = messages[conflictType] || 'Branch "' + branchName + '" already exists.';

            // Show dialog
            overlay.style.display = 'flex';

            // Handle rename button
            renameBtn.onclick = function() {
                overlay.style.display = 'none';
                // Re-prompt for new name
                promptForName(assistant, sessionUUID, debug);
            };

            // Handle use existing button
            useBtn.onclick = function() {
                overlay.style.display = 'none';
                navigateToSession(assistant, sessionUUID, debug, name);
            };

            // Close on overlay click
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            };
        }

        function deleteRecording(uuid, button) {
            if (!confirm('Delete this recording?')) {
                return;
            }
            fetch('/api/recording/' + uuid, {
                method: 'DELETE'
            }).then(function(response) {
                if (response.ok) {
                    var item = button.closest('.recording-item');
                    if (item) {
                        item.remove();
                    }
                    // Update the count in the agent group header
                    var agentGroup = button.closest('.agent-group');
                    if (agentGroup) {
                        var recordings = agentGroup.querySelectorAll('.recording-item').length;
                        var sessions = agentGroup.querySelectorAll('.session-item').length;
                        var countEl = agentGroup.querySelector('.agent-group__count');
                        if (countEl) {
                            var parts = [];
                            if (sessions > 0) {
                                parts.push(sessions + ' session' + (sessions > 1 ? 's' : ''));
                            }
                            if (recordings > 0) {
                                parts.push(recordings + ' recording' + (recordings > 1 ? 's' : ''));
                            }
                            countEl.textContent = parts.join(', ');
                            if (parts.length === 0) {
                                countEl.textContent = '';
                            }
                        }
                    }
                } else {
                    alert('Failed to delete recording');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        // Fetch and display existing worktrees as quick-start links
        (function() {
            fetch('/api/worktrees')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var worktrees = data.worktrees || [];
                    if (worktrees.length === 0) {
                        return;
                    }

                    // For each agent group, add worktree links after the new-session link
                    var agentGroups = document.querySelectorAll('.agent-group');
                    agentGroups.forEach(function(group) {
                        var assistant = group.getAttribute('data-assistant');
                        var newSessionLink = group.querySelector('.new-session');
                        if (!newSessionLink) {
                            return;
                        }

                        // Check if debug mode is enabled (from existing link)
                        var existingSessionLink = group.querySelector('.session-item');
                        var debug = existingSessionLink && existingSessionLink.href.indexOf('debug=1') !== -1;

                        // Create worktree links
                        worktrees.forEach(function(wt) {
                            var link = document.createElement('a');
                            link.className = 'worktree-link';

                            // Generate a new UUID for this session
                            var uuid = crypto.randomUUID ? crypto.randomUUID() :
                                'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                                    return v.toString(16);
                                });

                            // Build URL and set href directly so cmd-click/middle-click work
                            var url = '/session/' + uuid + '?assistant=' + encodeURIComponent(assistant) + '&name=' + encodeURIComponent(wt.name);
                            if (debug) {
                                url += '&debug=1';
                            }
                            link.href = url;

                            link.innerHTML = '<span class="worktree-link__icon">‚Ü≥</span>' +
                                '<span class="worktree-link__text">Start new session in ' + wt.name + '</span>';

                            // Insert after new-session link
                            newSessionLink.parentNode.insertBefore(link, newSessionLink.nextSibling);
                        });
                    });
                })
                .catch(function(err) {
                    console.error('Failed to fetch worktrees:', err);
                });
        })();
    </script>
</body>
</html>
