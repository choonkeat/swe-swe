<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>swe-swe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .selection-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
            padding: 24px;
        }
        .selection-page__header {
            text-align: center;
            margin-bottom: 32px;
        }
        .selection-page__title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        .selection-page__subtitle {
            font-size: 14px;
            color: #888;
        }
        .agents-list {
            max-width: 600px;
            width: 100%;
        }
        .agent-group {
            margin-bottom: 24px;
        }
        .agent-group__header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #404040;
        }
        .agent-group__icon {
            font-size: 24px;
        }
        .agent-group__name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        .agent-group__count {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }
        .agent-group__sessions {
            padding-left: 16px;
        }
        .session-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 4px 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            transition: all 0.15s ease;
        }
        .session-item:hover {
            border-color: #007acc;
            background: #333;
        }
        .session-item__uuid {
            font-family: monospace;
            font-size: 14px;
            color: #9cdcfe;
        }
        .session-item__viewers {
            font-size: 12px;
            color: #888;
        }
        .session-item__duration {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }
        .new-session {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin: 4px 0;
            background: transparent;
            border: 1px dashed #404040;
            border-radius: 6px;
            text-decoration: none;
            color: #888;
            transition: all 0.15s ease;
        }
        .new-session:hover {
            border-color: #007acc;
            color: #fff;
            background: #2d2d2d;
        }
        .new-session__icon {
            font-size: 14px;
        }
        .new-session__text {
            font-size: 14px;
        }
        /* Assistant-specific hover colors */
        .agent-group[data-assistant="claude"] .session-item:hover,
        .agent-group[data-assistant="claude"] .new-session:hover {
            border-color: #d97706;
        }
        .agent-group[data-assistant="gemini"] .session-item:hover,
        .agent-group[data-assistant="gemini"] .new-session:hover {
            border-color: #4285f4;
        }
        .agent-group[data-assistant="codex"] .session-item:hover,
        .agent-group[data-assistant="codex"] .new-session:hover {
            border-color: #10a37f;
        }
        .agent-group[data-assistant="goose"] .session-item:hover,
        .agent-group[data-assistant="goose"] .new-session:hover {
            border-color: #f472b6;
        }
        .agent-group[data-assistant="aider"] .session-item:hover,
        .agent-group[data-assistant="aider"] .new-session:hover {
            border-color: #22c55e;
        }
        .agent-group[data-assistant="custom"] .session-item:hover,
        .agent-group[data-assistant="custom"] .new-session:hover {
            border-color: #a855f7;
        }
        .selection-page__footer {
            margin-top: auto;
            padding-top: 32px;
            text-align: center;
        }
        .ssl-cert-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            color: #888;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .ssl-cert-link:hover {
            color: #fff;
            border-color: #007acc;
            background: #2d2d2d;
        }
        .footer-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            color: #888;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .github-link:hover {
            color: #fff;
            border-color: #007acc;
            background: #2d2d2d;
        }
        .github-link svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .ios-safari-warning {
            display: none;
            max-width: 600px;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 24px;
            background: #442c00;
            border: 1px solid #d97706;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
        }
        .ios-safari-warning__title {
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 4px;
        }
        .ios-safari-warning__text {
            color: #fcd34d;
        }
        .ios-safari-warning a {
            color: #fbbf24;
            text-decoration: underline;
        }
        /* Recording items within agent groups */
        .recording-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 4px 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .recording-item:hover {
            border-color: #6b7280;
            background: #333;
        }
        .recording-item__name {
            font-family: monospace;
            font-size: 14px;
            color: #9cdcfe;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .recording-item__time {
            font-size: 12px;
            color: #888;
        }
        .recording-item__status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .recording-item__status--saved {
            color: #4caf50;
        }
        .recording-item__status--expires {
            color: #ff9800;
        }
        .recording-item__actions {
            display: flex;
            gap: 8px;
        }
        .recording-item__play {
            padding: 4px 8px;
            font-size: 12px;
            color: #9cdcfe;
            text-decoration: none;
            border: 1px solid #404040;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        .recording-item__play:hover {
            border-color: #007acc;
            background: #2d2d2d;
        }
        .recording-item__delete {
            padding: 4px 8px;
            font-size: 12px;
            color: #888;
            background: none;
            border: 1px solid #404040;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .recording-item__delete:hover {
            color: #ef4444;
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        /* New Session Dialog */
        .new-session-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .new-session-dialog {
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        .new-session-dialog__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .new-session-dialog__title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        .new-session-dialog__close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .new-session-dialog__close:hover {
            color: #fff;
        }
        .new-session-dialog__field {
            margin-bottom: 20px;
        }
        .new-session-dialog__label {
            display: block;
            font-size: 14px;
            color: #d4d4d4;
            margin-bottom: 8px;
        }
        .new-session-dialog__row {
            display: flex;
            gap: 8px;
        }
        .new-session-dialog__input {
            flex: 1;
            padding: 10px 12px;
            font-size: 14px;
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #d4d4d4;
        }
        .new-session-dialog__input:focus {
            outline: none;
            border-color: #007acc;
        }
        .new-session-dialog__input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .new-session-dialog__next {
            padding: 10px 16px;
            font-size: 14px;
            background: #404040;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #d4d4d4;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .new-session-dialog__next:hover:not(:disabled) {
            background: #505050;
            border-color: #007acc;
        }
        .new-session-dialog__next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .new-session-dialog__agents {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .new-session-dialog__agent {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .new-session-dialog__agent:hover:not(.new-session-dialog__agent--disabled) {
            border-color: #007acc;
        }
        .new-session-dialog__agent--selected {
            border-color: #007acc;
            background: #2d3748;
        }
        .new-session-dialog__agent--disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .new-session-dialog__agent-icon {
            font-size: 16px;
        }
        .new-session-dialog__agent-name {
            font-size: 14px;
            color: #d4d4d4;
        }
        .new-session-dialog__agent input[type="radio"] {
            display: none;
        }
        .new-session-dialog__footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
        }
        .new-session-dialog__error {
            color: #ef4444;
            font-size: 13px;
            flex: 1;
        }
        .new-session-dialog__start {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .new-session-dialog__start:hover:not(:disabled) {
            background: #16a34a;
        }
        .new-session-dialog__start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .new-session-dialog__loading {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #888;
        }
        .new-session-dialog__spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #404040;
            border-top-color: #007acc;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .recording-item__keep {
            padding: 4px 8px;
            font-size: 12px;
            color: #888;
            background: none;
            border: 1px solid #404040;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .recording-item__keep:hover {
            color: #22c55e;
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .recordings-section {
            margin-top: 8px;
            padding-left: 8px;
            border-left: 2px solid #404040;
            margin-left: 8px;
        }
        .recordings-section__label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            padding: 4px 0;
        }
        .recordings-section--recent .recordings-section__label {
            color: #888;
        }
        .recordings-section--kept .recordings-section__label {
            color: #22c55e;
        }
    </style>
</head>
<body>
    <!-- New Session dialog -->
    <div class="new-session-dialog-overlay" id="new-session-dialog-overlay">
        <div class="new-session-dialog">
            <div class="new-session-dialog__header">
                <div class="new-session-dialog__title">New Session</div>
                <button class="new-session-dialog__close" id="new-session-close">&times;</button>
            </div>
            <div class="new-session-dialog__field">
                <label class="new-session-dialog__label">Repository</label>
                <div class="new-session-dialog__row">
                    <input type="text" class="new-session-dialog__input" id="new-session-repo" list="repo-history" placeholder="Repository URL or /workspace">
                    <datalist id="repo-history"></datalist>
                    <button class="new-session-dialog__next" id="new-session-repo-next">Next</button>
                </div>
            </div>
            <div class="new-session-dialog__field">
                <label class="new-session-dialog__label">Branch (optional)</label>
                <div class="new-session-dialog__row">
                    <input type="text" class="new-session-dialog__input" id="new-session-branch" list="branch-list" placeholder="Leave blank for default branch" disabled>
                    <datalist id="branch-list"></datalist>
                    <button class="new-session-dialog__next" id="new-session-branch-next" disabled>Next</button>
                </div>
            </div>
            <div class="new-session-dialog__field">
                <label class="new-session-dialog__label">Agent</label>
                <div class="new-session-dialog__agents" id="new-session-agents">
                    {{range .Agents}}
                    <label class="new-session-dialog__agent new-session-dialog__agent--disabled" data-agent="{{.Assistant.Binary}}">
                        <input type="radio" name="new-session-agent" value="{{.Assistant.Binary}}" disabled>
                        <span class="new-session-dialog__agent-icon">{{if eq .Assistant.Binary "claude"}}üß†{{else if eq .Assistant.Binary "gemini"}}‚ú®{{else if eq .Assistant.Binary "codex"}}ü§ñ{{else if eq .Assistant.Binary "goose"}}ü™ø{{else if eq .Assistant.Binary "aider"}}üõ†{{else}}‚öôÔ∏è{{end}}</span>
                        <span class="new-session-dialog__agent-name">{{.Assistant.Name}}</span>
                    </label>
                    {{end}}
                </div>
            </div>
            <div class="new-session-dialog__footer">
                <div class="new-session-dialog__error" id="new-session-error"></div>
                <div class="new-session-dialog__loading" id="new-session-loading">
                    <div class="new-session-dialog__spinner"></div>
                    <span id="new-session-loading-text">Loading...</span>
                </div>
                <button class="new-session-dialog__start" id="new-session-start" disabled>Start Session</button>
            </div>
        </div>
    </div>
    <div class="selection-page">
        <div class="selection-page__header">
            <h1 class="selection-page__title">swe-swe</h1>
            <p class="selection-page__subtitle">Join an existing session or start a new one</p>
        </div>
        <div class="ios-safari-warning" id="ios-safari-warning">
            <div class="ios-safari-warning__title">iOS Safari + Self-Signed Certs</div>
            <div class="ios-safari-warning__text">
                WebSocket connections may not work in Safari with self-signed certificates.
                Please use <strong>Chrome</strong> or another browser on iOS for best results.
            </div>
        </div>
        <div class="agents-list">
            {{range .Agents}}
            <div class="agent-group" data-assistant="{{.Assistant.Binary}}">
                <div class="agent-group__header">
                    <span class="agent-group__icon">{{if eq .Assistant.Binary "claude"}}üß†{{else if eq .Assistant.Binary "gemini"}}‚ú®{{else if eq .Assistant.Binary "codex"}}ü§ñ{{else if eq .Assistant.Binary "goose"}}ü™ø{{else if eq .Assistant.Binary "aider"}}üõ†{{else}}‚öôÔ∏è{{end}}</span>
                    <span class="agent-group__name">{{.Assistant.Name}}</span>
                    {{if or .Sessions .Recordings}}<span class="agent-group__count">{{if .Sessions}}{{len .Sessions}} session{{if gt (len .Sessions) 1}}s{{end}}{{end}}{{if and .Sessions .Recordings}}, {{end}}{{if .Recordings}}{{len .Recordings}} recording{{if gt (len .Recordings) 1}}s{{end}}{{end}}</span>{{end}}
                </div>
                <div class="agent-group__sessions">
                    {{range .Sessions}}
                    <a href="/session/{{.UUID}}?assistant={{.Assistant}}{{if $.Debug}}&debug=1{{end}}" class="session-item">
                        <span class="session-item__uuid">{{if .Name}}{{.Name}} ({{.UUIDShort}}){{else}}{{.UUIDShort}}{{end}}</span>
                        <span class="session-item__viewers">{{.ClientCount}} viewer{{if ne .ClientCount 1}}s{{end}}</span>
                        <span class="session-item__duration">{{.DurationStr}}</span>
                    </a>
                    {{end}}
                    <a href="#" onclick="startNewSession('{{.Assistant.Binary}}', '{{$.NewUUID}}', {{$.Debug}}); return false;" class="new-session">
                        <span class="new-session__icon">+</span>
                        <span class="new-session__text">Start new session</span>
                    </a>
                    {{if .Recordings}}
                    <div class="recordings-section">
                        <div class="recordings-section__label">Recordings</div>
                        {{range .Recordings}}
                        <div class="recording-item{{if .IsKept}} recording-item--kept{{end}}" data-uuid="{{.UUID}}">
                            <span class="recording-item__name">{{if .Name}}{{.Name}}{{else}}session-{{.UUIDShort}}{{end}}</span>
                            <span class="recording-item__time">{{.EndedAgo}}</span>
                            <span class="recording-item__status{{if .IsKept}} recording-item__status--saved{{else}} recording-item__status--expires{{end}}">{{if .IsKept}}Saved{{else}}Expires in {{.ExpiresIn}}{{end}}</span>
                            <div class="recording-item__actions">
                                <a href="/recording/{{.UUID}}" class="recording-item__play">View</a>
                                {{if .IsKept}}
                                <button class="recording-item__delete" onclick="deleteRecording('{{.UUID}}', this)">Delete</button>
                                {{else}}
                                <button class="recording-item__keep" onclick="keepRecording('{{.UUID}}', this)">Keep</button>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        <div class="selection-page__footer">
            <div class="footer-links">
                {{if .HasSSLCert}}
                <a href="/ssl/ca.crt" class="ssl-cert-link">
                    <span>üì±</span>
                    <span>Install SSL Certificate</span>
                </a>
                {{end}}
                <a href="https://github.com/choonkeat/swe-swe" target="_blank" rel="noopener" class="github-link">
                    <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                    <span>GitHub</span>
                </a>
            </div>
        </div>
    </div>
    <script>
        // Detect iOS Safari and show warning for self-signed cert scenarios
        (function() {
            var ua = navigator.userAgent;
            var isIOS = /iPad|iPhone|iPod/.test(ua);
            var isSafari = /Safari/.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/.test(ua);
            var isHTTPS = location.protocol === 'https:';

            if (isIOS && isSafari && isHTTPS) {
                var warning = document.getElementById('ios-safari-warning');
                if (warning) {
                    warning.style.display = 'block';
                }
            }
        })();

        // Use embedded rendering for recordings on mobile devices.
        // Streaming mode lacks touch-scroll-proxy that terminal-ui.js has,
        // causing broken/janky scrolling. Embedded mode renders better.
        (function() {
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           (navigator.maxTouchPoints > 0 && window.innerWidth < 1024);
            if (isMobile) {
                document.querySelectorAll('a.recording-item__play').forEach(function(link) {
                    if (link.href && link.href.indexOf('?') === -1) {
                        link.href += '?render=embedded';
                    }
                });
            }
        })();

        function startNewSession(assistant, sessionUUID, debug) {
            // Open New Session dialog with agent pre-selected
            openNewSessionDialog(assistant, sessionUUID, debug);
        }

        function deleteRecording(uuid, button) {
            if (!confirm('Delete this recording?')) {
                return;
            }
            fetch('/api/recording/' + uuid, {
                method: 'DELETE'
            }).then(function(response) {
                if (response.ok) {
                    var item = button.closest('.recording-item');
                    if (item) {
                        item.remove();
                    }
                    // Update the count in the agent group header
                    var agentGroup = button.closest('.agent-group');
                    if (agentGroup) {
                        var recordings = agentGroup.querySelectorAll('.recording-item').length;
                        var sessions = agentGroup.querySelectorAll('.session-item').length;
                        var countEl = agentGroup.querySelector('.agent-group__count');
                        if (countEl) {
                            var parts = [];
                            if (sessions > 0) {
                                parts.push(sessions + ' session' + (sessions > 1 ? 's' : ''));
                            }
                            if (recordings > 0) {
                                parts.push(recordings + ' recording' + (recordings > 1 ? 's' : ''));
                            }
                            countEl.textContent = parts.join(', ');
                            if (parts.length === 0) {
                                countEl.textContent = '';
                            }
                        }
                    }
                } else {
                    alert('Failed to delete recording');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        function keepRecording(uuid, button) {
            fetch('/api/recording/' + uuid + '/keep', {
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    // Move the recording item from Recent to Kept section
                    var item = button.closest('.recording-item');
                    var agentGroup = button.closest('.agent-group');
                    var recentSection = button.closest('.recordings-section--recent');

                    if (item && agentGroup) {
                        // Find or create the Kept section
                        var keptSection = agentGroup.querySelector('.recordings-section--kept');
                        if (!keptSection) {
                            keptSection = document.createElement('div');
                            keptSection.className = 'recordings-section recordings-section--kept';
                            keptSection.innerHTML = '<div class="recordings-section__label">Kept</div>';
                            // Insert after Recent section or at the end of agent-group__sessions
                            var sessionsDiv = agentGroup.querySelector('.agent-group__sessions');
                            if (sessionsDiv) {
                                sessionsDiv.appendChild(keptSection);
                            }
                        }

                        // Transform the item: change Keep button to Delete button
                        var keepBtn = item.querySelector('.recording-item__keep');
                        if (keepBtn) {
                            var deleteBtn = document.createElement('button');
                            deleteBtn.className = 'recording-item__delete';
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.onclick = function() { deleteRecording(uuid, deleteBtn); };
                            keepBtn.replaceWith(deleteBtn);
                        }
                        item.classList.add('recording-item--kept');

                        // Move to Kept section
                        keptSection.appendChild(item);

                        // Remove Recent section if empty
                        if (recentSection && recentSection.querySelectorAll('.recording-item').length === 0) {
                            recentSection.remove();
                        }
                    }
                } else {
                    alert('Failed to keep recording');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        // New Session Dialog functionality
        (function() {
            var overlay = document.getElementById('new-session-dialog-overlay');
            var closeBtn = document.getElementById('new-session-close');
            var repoInput = document.getElementById('new-session-repo');
            var repoNextBtn = document.getElementById('new-session-repo-next');
            var branchInput = document.getElementById('new-session-branch');
            var branchNextBtn = document.getElementById('new-session-branch-next');
            var agentsContainer = document.getElementById('new-session-agents');
            var startBtn = document.getElementById('new-session-start');
            var errorDiv = document.getElementById('new-session-error');
            var loadingDiv = document.getElementById('new-session-loading');
            var loadingText = document.getElementById('new-session-loading-text');
            var repoHistoryList = document.getElementById('repo-history');
            var branchList = document.getElementById('branch-list');

            // Dialog state
            var dialogState = {
                sessionUUID: '',
                debug: false,
                repoPath: '',
                selectedBranch: '',
                selectedAgent: '',
                preSelectedAgent: ''
            };

            // localStorage key for repo history
            var REPO_HISTORY_KEY = 'swe-swe-repo-history';

            // Load repo history from localStorage
            function loadRepoHistory() {
                try {
                    var history = JSON.parse(localStorage.getItem(REPO_HISTORY_KEY) || '[]');
                    repoHistoryList.innerHTML = '';
                    history.forEach(function(url) {
                        var option = document.createElement('option');
                        option.value = url;
                        repoHistoryList.appendChild(option);
                    });
                } catch (e) {
                    console.error('Failed to load repo history:', e);
                }
            }

            // Save URL to repo history
            function saveToRepoHistory(url) {
                try {
                    var history = JSON.parse(localStorage.getItem(REPO_HISTORY_KEY) || '[]');
                    // Remove if already exists
                    history = history.filter(function(u) { return u !== url; });
                    // Add to front
                    history.unshift(url);
                    // Keep only last 10
                    history = history.slice(0, 10);
                    localStorage.setItem(REPO_HISTORY_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error('Failed to save repo history:', e);
                }
            }

            // Get default repo URL from backend (workspace origin URL)
            function getDefaultRepoUrl() {
                return '{{.DefaultRepoUrl}}';
            }

            // Reset dialog to initial state
            function resetDialog() {
                repoInput.value = getDefaultRepoUrl();
                repoInput.disabled = false;
                repoNextBtn.disabled = false;
                branchInput.value = '';
                branchInput.disabled = true;
                branchNextBtn.disabled = true;
                branchList.innerHTML = '';
                errorDiv.textContent = '';
                loadingDiv.style.display = 'none';
                startBtn.disabled = true;

                // Reset agents
                var agentLabels = agentsContainer.querySelectorAll('.new-session-dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.add('new-session-dialog__agent--disabled');
                    label.classList.remove('new-session-dialog__agent--selected');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = true;
                        radio.checked = false;
                    }
                });

                dialogState.repoPath = '';
                dialogState.selectedBranch = '';
                dialogState.selectedAgent = '';
            }

            // Open the dialog
            window.openNewSessionDialog = function(preSelectedAgent, sessionUUID, debug) {
                dialogState.sessionUUID = sessionUUID;
                dialogState.debug = debug;
                dialogState.preSelectedAgent = preSelectedAgent || '';

                resetDialog();
                loadRepoHistory();
                overlay.style.display = 'flex';

                // Focus repo input
                setTimeout(function() { repoInput.focus(); }, 100);
            };

            // Close the dialog
            function closeDialog() {
                overlay.style.display = 'none';
                resetDialog();
            }

            // Show error message
            function showError(msg) {
                errorDiv.textContent = msg;
                loadingDiv.style.display = 'none';
            }

            // Show loading state
            function showLoading(msg) {
                loadingText.textContent = msg || 'Loading...';
                loadingDiv.style.display = 'flex';
                errorDiv.textContent = '';
            }

            // Hide loading state
            function hideLoading() {
                loadingDiv.style.display = 'none';
            }

            // Enable branch field
            function enableBranchField() {
                branchInput.disabled = false;
                branchNextBtn.disabled = false;
            }

            // Enable agent selection
            function enableAgentSelection() {
                var agentLabels = agentsContainer.querySelectorAll('.new-session-dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.remove('new-session-dialog__agent--disabled');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = false;
                    }
                });

                // If there's a pre-selected agent, select it
                if (dialogState.preSelectedAgent) {
                    var preSelectedLabel = agentsContainer.querySelector('[data-agent="' + dialogState.preSelectedAgent + '"]');
                    if (preSelectedLabel) {
                        var radio = preSelectedLabel.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            preSelectedLabel.classList.add('new-session-dialog__agent--selected');
                            dialogState.selectedAgent = dialogState.preSelectedAgent;
                            startBtn.disabled = false;
                        }
                    }
                }
            }

            // Handle Repo Next button
            repoNextBtn.addEventListener('click', function() {
                var repoUrl = repoInput.value.trim();
                if (!repoUrl) {
                    showError('Please enter a repository URL');
                    return;
                }

                showLoading('Preparing repository...');
                repoInput.disabled = true;
                repoNextBtn.disabled = true;

                // For Phase 2 (UI only), just simulate the async operation
                // Phase 3 will add the actual backend call
                fetch('/api/repo/prepare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: repoUrl })
                })
                .then(function(response) {
                    if (!response.ok) {
                        return response.json().then(function(data) {
                            throw new Error(data.error || 'Failed to prepare repository');
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    dialogState.repoPath = data.path;
                    saveToRepoHistory(repoUrl);

                    // Fetch branches
                    return fetch('/api/repo/branches?path=' + encodeURIComponent(data.path));
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to fetch branches');
                    }
                    return response.json();
                })
                .then(function(data) {
                    hideLoading();

                    // Populate branch datalist
                    branchList.innerHTML = '';
                    (data.branches || []).forEach(function(branch) {
                        var option = document.createElement('option');
                        option.value = branch;
                        branchList.appendChild(option);
                    });

                    enableBranchField();
                    branchInput.focus();
                })
                .catch(function(err) {
                    hideLoading();
                    repoInput.disabled = false;
                    repoNextBtn.disabled = false;
                    showError(err.message || 'Failed to prepare repository');
                });
            });

            // Handle Branch Next button
            branchNextBtn.addEventListener('click', function() {
                dialogState.selectedBranch = branchInput.value.trim();
                enableAgentSelection();
            });

            // Handle branch input change (selecting from dropdown)
            branchInput.addEventListener('change', function() {
                // If user selected from dropdown, auto-advance
                if (branchInput.value) {
                    dialogState.selectedBranch = branchInput.value.trim();
                    enableAgentSelection();
                }
            });

            // Handle agent selection
            agentsContainer.addEventListener('click', function(e) {
                var label = e.target.closest('.new-session-dialog__agent');
                if (!label || label.classList.contains('new-session-dialog__agent--disabled')) {
                    return;
                }

                // Deselect all
                var allLabels = agentsContainer.querySelectorAll('.new-session-dialog__agent');
                allLabels.forEach(function(l) {
                    l.classList.remove('new-session-dialog__agent--selected');
                });

                // Select this one
                label.classList.add('new-session-dialog__agent--selected');
                var radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    dialogState.selectedAgent = radio.value;
                    startBtn.disabled = false;
                }
            });

            // Handle Start Session button
            startBtn.addEventListener('click', function() {
                if (!dialogState.selectedAgent) {
                    showError('Please select an agent');
                    return;
                }

                // Navigate to session with appropriate parameters
                var url = '/session/' + dialogState.sessionUUID + '?assistant=' + encodeURIComponent(dialogState.selectedAgent);
                if (dialogState.debug) {
                    url += '&debug=1';
                }
                if (dialogState.repoPath && dialogState.repoPath !== '/workspace') {
                    url += '&pwd=' + encodeURIComponent(dialogState.repoPath);
                }
                if (dialogState.selectedBranch) {
                    url += '&name=' + encodeURIComponent(dialogState.selectedBranch);
                }

                window.location.href = url;
            });

            // Close button
            closeBtn.addEventListener('click', closeDialog);

            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeDialog();
                }
            });

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay.style.display === 'flex') {
                    closeDialog();
                }
            });

            // Handle repo input change (resetting downstream fields)
            repoInput.addEventListener('input', function() {
                // If repo changes, reset downstream
                branchInput.value = '';
                branchInput.disabled = true;
                branchNextBtn.disabled = true;
                branchList.innerHTML = '';
                dialogState.selectedBranch = '';
                dialogState.selectedAgent = '';
                startBtn.disabled = true;

                var agentLabels = agentsContainer.querySelectorAll('.new-session-dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.add('new-session-dialog__agent--disabled');
                    label.classList.remove('new-session-dialog__agent--selected');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = true;
                        radio.checked = false;
                    }
                });
            });
        })();
    </script>
</body>
</html>
