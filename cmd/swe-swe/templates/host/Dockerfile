# swe-swe development environment
# Based on golang image with Node.js and AI assistant tools
# Generated by: swe-swe init

# Stage 1: Build swe-swe-server from source
FROM golang:1.23-alpine AS server-builder
WORKDIR /build
COPY swe-swe-server/go.mod swe-swe-server/go.sum ./
RUN go mod download
COPY swe-swe-server/*.go ./
COPY swe-swe-server/static/ ./static/
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o swe-swe-server .

# Stage 2: Main development environment
FROM golang:1.23-bookworm

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    ca-certificates \
    jq \
    unzip \
    vim \
    && rm -rf /var/lib/apt/lists/*

# {{IF CERTS}}
# Install enterprise certificates early (before curl commands that need SSL verification)
COPY certs/ /tmp/enterprise-certs/
RUN mkdir -p /usr/local/share/ca-certificates && \
    for cert in /tmp/enterprise-certs/*; do \
      cp "$cert" "/usr/local/share/ca-certificates/$(basename "$cert").crt"; \
    done && \
    update-ca-certificates && \
    rm -rf /tmp/enterprise-certs
# {{ENDIF}}

# {{IF NODEJS}}
# Install Node.js 24 LTS from NodeSource (Debian repos only have EOL Node.js 18)
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Ensure npm global packages are in PATH
ENV PATH="/usr/local/lib/node_modules/.bin:${PATH}"
# {{ENDIF}}

# {{IF PYTHON}}
# Install Python and pip for AI assistants
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*
# {{ENDIF}}

# {{IF APT_PACKAGES}}
# Install user-specified packages
RUN apt-get update && apt-get install -y \
    {{APT_PACKAGES}} \
    && rm -rf /var/lib/apt/lists/*
# {{ENDIF}}

# {{IF CLAUDE}}
# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code
# {{ENDIF}}

# {{IF GEMINI}}
# Install Gemini CLI
RUN npm install -g @google/gemini-cli
# {{ENDIF}}

# {{IF CODEX}}
# Install Codex CLI
RUN npm install -g @openai/codex
# {{ENDIF}}

# {{IF NODEJS}}
# Install MCP Playwright for browser automation
# This enables the system to control browsers via Playwright CDP connections
RUN npm install -g @playwright/mcp
# {{ENDIF}}

# {{IF AIDER}}
# Install aider
RUN pip3 install --break-system-packages aider-chat
# {{ENDIF}}

# {{IF GOOSE}}
# Install Goose (AI pair programmer from Block)
RUN curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | GOOSE_BIN_DIR=/usr/local/bin CONFIGURE=false bash
# {{ENDIF}}

# {{IF OPENCODE}}
# Install OpenCode CLI (https://github.com/anomalyco/opencode)
RUN npm install -g opencode-ai
# {{ENDIF}}

# {{IF NPM_PACKAGES}}
# Install user-specified npm packages
RUN npm install -g {{NPM_PACKAGES}}
# {{ENDIF}}

# {{IF DOCKER}}
# Install Docker CLI only (talks to host Docker via mounted socket)
RUN ARCH="$(dpkg --print-architecture)" && \
    case "${ARCH}" in \
        amd64) DOCKER_ARCH="x86_64" ;; \
        arm64) DOCKER_ARCH="aarch64" ;; \
        armhf) DOCKER_ARCH="armhf" ;; \
        *) echo "Unsupported architecture: ${ARCH}" && exit 1 ;; \
    esac && \
    curl -fsSL "https://download.docker.com/linux/static/stable/${DOCKER_ARCH}/docker-27.4.1.tgz" | \
    tar xz -C /usr/local/bin --strip-components=1 docker/docker

# Install Docker Compose plugin (enables `docker compose` command)
RUN ARCH="$(dpkg --print-architecture)" && \
    case "${ARCH}" in \
        amd64) COMPOSE_ARCH="x86_64" ;; \
        arm64) COMPOSE_ARCH="aarch64" ;; \
        *) echo "Unsupported architecture: ${ARCH}" && exit 1 ;; \
    esac && \
    mkdir -p /usr/local/lib/docker/cli-plugins && \
    curl -fsSL "https://github.com/docker/compose/releases/download/v2.32.4/docker-compose-linux-${COMPOSE_ARCH}" \
        -o /usr/local/lib/docker/cli-plugins/docker-compose && \
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
# {{ENDIF}}

# {{IF SLASH_COMMANDS}}
# Clone slash commands repositories to temp location
# (will be copied to home directory by entrypoint.sh)
{{SLASH_COMMANDS_CLONE}}
# {{ENDIF}}

# Enterprise certificate support
# swe-swe init detects NODE_EXTRA_CA_CERTS/SSL_CERT_FILE env vars and copies certs
# to .swe-swe/certs/. The entrypoint.sh installs them into the system trust store.

# Copy swe-swe-server binary from builder stage
COPY --from=server-builder /build/swe-swe-server /usr/local/bin/swe-swe-server

# Copy entrypoint script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create non-root user for running swe-swe-server
# If target GID already exists (e.g., dialout=20), use that group; otherwise create app group
# Use -K to suppress warnings about macOS UIDs (501+) being below Linux UID_MIN (1000)
RUN if ! getent group {{GID}} > /dev/null; then groupadd -K GID_MIN=20 -g {{GID}} app; fi && \
    useradd -m -K UID_MIN=100 -u {{UID}} -g {{GID}} -s /bin/bash app

# Create worktrees directory with app ownership (used for git worktrees)
RUN mkdir -p /worktrees && chown {{UID}}:{{GID}} /worktrees

# Create repos directory with app ownership (used for cloning external repos)
RUN mkdir -p /repos && chown {{UID}}:{{GID}} /repos

# Entrypoint runs as root to install certificates,
# then switches to app user to run swe-swe-server
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Default working directory (entrypoint will cd to /workspace for the server)
WORKDIR /workspace

# Default command: run swe-swe-server pointing to /workspace
CMD ["/usr/local/bin/swe-swe-server", "-working-directory", "/workspace", "-addr", "0.0.0.0:9898"]
