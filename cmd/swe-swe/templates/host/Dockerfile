# swe-swe development environment
# Based on golang image with Node.js and AI assistant tools
# Generated by: swe-swe init

FROM golang:1.23-bookworm

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# {{IF NODEJS}}
# Install Node.js 24 LTS from NodeSource (Debian repos only have EOL Node.js 18)
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Ensure npm global packages are in PATH
ENV PATH="/usr/local/lib/node_modules/.bin:${PATH}"
# {{ENDIF}}

# {{IF PYTHON}}
# Install Python and pip for AI assistants
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*
# {{ENDIF}}

# {{IF APT_PACKAGES}}
# Install user-specified packages
RUN apt-get update && apt-get install -y \
    {{APT_PACKAGES}} \
    && rm -rf /var/lib/apt/lists/*
# {{ENDIF}}

# {{IF CLAUDE}}
# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code
# {{ENDIF}}

# {{IF GEMINI}}
# Install Gemini CLI
RUN npm install -g @google/gemini-cli
# {{ENDIF}}

# {{IF CODEX}}
# Install Codex CLI
RUN npm install -g @openai/codex
# {{ENDIF}}

# {{IF NODEJS}}
# Install MCP Playwright for browser automation
# This enables the system to control browsers via Playwright CDP connections
RUN npm install -g @playwright/mcp
# {{ENDIF}}

# {{IF AIDER}}
# Install aider
RUN pip3 install --break-system-packages aider-chat
# {{ENDIF}}

# {{IF GOOSE}}
# Install Goose (AI pair programmer from Block)
RUN curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | GOOSE_BIN_DIR=/usr/local/bin CONFIGURE=false bash
# {{ENDIF}}

# {{IF NPM_PACKAGES}}
# Install user-specified npm packages
RUN npm install -g {{NPM_PACKAGES}}
# {{ENDIF}}

# Enterprise certificate support
# swe-swe init detects NODE_EXTRA_CA_CERTS/SSL_CERT_FILE env vars and copies certs
# to .swe-swe/certs/. The entrypoint.sh installs them into the system trust store.

# Copy entrypoint script (binary is volume-mounted from host)
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create non-root user for running swe-swe-server
RUN useradd -m -s /bin/bash app

# Entrypoint runs as root to install certificates,
# then switches to app user to run swe-swe-server
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Default working directory (entrypoint will cd to /workspace for the server)
WORKDIR /workspace

# Default command: run swe-swe-server pointing to /workspace
CMD ["/usr/local/bin/swe-swe-server", "-working-directory", "/workspace", "-addr", "0.0.0.0:9898"]
