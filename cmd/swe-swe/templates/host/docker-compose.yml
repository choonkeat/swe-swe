services:
  traefik:
    image: traefik:v3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--entrypoints.web.address=:7000"
    ports:
      - "${SWE_PORT:-9899}:7000"
      - "${SWE_DASHBOARD_PORT:-9900}:8080"  # Traefik dashboard at traefik.lvh.me:${SWE_PORT:-9899}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik-dynamic.yml:/etc/traefik/dynamic.yml:ro"
    networks:
      - swe-network
    restart: unless-stopped

  chrome:
    build:
      context: .
      dockerfile: chrome/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chrome.rule=HostRegexp(`chrome\\..*`)"
      - "traefik.http.routers.chrome.priority=100"
      - "traefik.http.services.chrome.loadbalancer.server.port=6080"
    volumes:
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
    networks:
      - swe-network
    restart: unless-stopped
    # Resource limits for X11/VNC rendering
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  swe-swe:
    build:
      context: .
      dockerfile: Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.swe-swe.rule=HostRegexp(`.*`)"
      - "traefik.http.routers.swe-swe.priority=10"
      - "traefik.http.services.swe-swe.loadbalancer.server.port=9898"
      # Uncomment below to enable basic auth (edit traefik-dynamic.yml to configure credentials)
      # - "traefik.http.routers.swe-swe.middlewares=auth@file"
    depends_on:
      - chrome
    volumes:
      # Mount project directory to /workspace
      - ${WORKSPACE_DIR:-.}:/workspace
      # Mount persistent home for auth/config storage
      - ./home:/home/app
      # Mount swe-swe-server binary from host (allows live updates)
      - ./bin/swe-swe-server:/usr/local/bin/swe-swe-server:ro
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
    working_dir: /workspace
    networks:
      - swe-network
    environment:
      # Pass through API keys (edit or set as environment variables)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Enterprise certificates (if configured during swe-swe init)
      - NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS}
      - SSL_CERT_FILE=${SSL_CERT_FILE}
      # Browser automation via MCP Playwright connected to chrome service
      - BROWSER_WS_ENDPOINT=ws://chrome:9223
      # Add other credentials as needed:
      # - GEMINI_API_KEY=${GEMINI_API_KEY}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped

  vscode-proxy:
    image: nginx:latest
    volumes:
      - ./nginx-vscode.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vscode.rule=PathPrefix(`/vscode`)"
      - "traefik.http.routers.vscode.priority=100"
      - "traefik.http.services.vscode.loadbalancer.server.port=8081"
      # Uncomment below to enable basic auth (edit traefik-dynamic.yml to configure credentials)
      # - "traefik.http.routers.vscode.middlewares=auth@file"
    depends_on:
      - code-server
    networks:
      - swe-network
    restart: unless-stopped

  code-server:
    image: codercom/code-server:latest
    command:
      - "--bind-addr=0.0.0.0:8080"
    volumes:
      # Mount project directory
      - ${WORKSPACE_DIR:-.}:/home/coder/project
      # Mount persistent home for VSCode settings/extensions
      - ./home:/home/coder
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
    working_dir: /home/coder/project
    networks:
      - swe-network
    environment:
      # VSCode password (set via SWE_SWE_PASSWORD env var)
      - PASSWORD=${SWE_SWE_PASSWORD:-changeme}
      - TZ=${TZ:-UTC}
      # Enterprise certificates (if configured during swe-swe init)
      - NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS}
      - SSL_CERT_FILE=${SSL_CERT_FILE}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

networks:
  swe-network:
    driver: bridge
