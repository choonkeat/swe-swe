services:
  traefik:
    image: traefik:v2.11
    command:
      - "--api=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=${PROJECT_NAME}_swe-network"
      # Only discover containers with matching project label (enables multi-project isolation)
      - "--providers.docker.constraints=Label(`swe.project`,`${PROJECT_NAME}`)"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--log.level=DEBUG"
      - "--accesslog=true"
      - "--accesslog.format=json"
# {{IF NO_SSL}}
      - "--entrypoints.web.address=:7000"
      - "--entrypoints.web.transport.respondingTimeouts.readTimeout=60s"
# {{ENDIF}}
# {{IF SSL}}
      - "--entrypoints.websecure.address=:7443"
      - "--entrypoints.websecure.transport.respondingTimeouts.readTimeout=60s"
      # Preview proxy entrypoint (separate port for app preview iframe)
      - "--entrypoints.previewsecure.address=:17443"
      - "--entrypoints.previewsecure.transport.respondingTimeouts.readTimeout=60s"
# {{ENDIF}}
    ports:
# {{IF NO_SSL}}
      - "${SWE_PORT:-1977}:7000"
# {{ENDIF}}
# {{IF SSL}}
      - "${SWE_PORT:-1977}:7443"
      # Preview proxy port (prepend "1" to SWE_PORT, e.g., 1977 -> 11977)
      - "1${SWE_PORT:-1977}:17443"
# {{ENDIF}}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik-dynamic.yml:/etc/traefik/dynamic.yml:ro"
# {{IF SSL}}
      - "${HOME}/.swe-swe/tls:/etc/traefik/tls:ro"
# {{ENDIF}}
    labels:
      # Project label for multi-instance isolation
      - "swe.project=${PROJECT_NAME}"
    networks:
      - swe-network
    depends_on:
      - auth
      - swe-swe
    restart: unless-stopped

  auth:
    build:
      context: ./auth
    environment:
      - SWE_SWE_PASSWORD=${SWE_SWE_PASSWORD:-changeme}
    labels:
      - "swe.project=${PROJECT_NAME}"
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-auth.rule=PathPrefix(`/swe-swe-auth`)"
      - "traefik.http.routers.${PROJECT_NAME}-auth.priority=200"
# {{IF SSL}}
      - "traefik.http.routers.${PROJECT_NAME}-auth.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-auth.tls=true"
# {{ENDIF}}
      - "traefik.http.services.${PROJECT_NAME}-auth.loadbalancer.server.port=4180"
    networks:
      - swe-network
    restart: unless-stopped

  chrome:
    build:
      context: .
      dockerfile: chrome-screencast/Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "swe.project=${PROJECT_NAME}"
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-chrome.rule=Path(`/chrome`) || PathPrefix(`/chrome/`)"
      - "traefik.http.routers.${PROJECT_NAME}-chrome.priority=100"
# {{IF SSL}}
      - "traefik.http.routers.${PROJECT_NAME}-chrome.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-chrome.tls=true"
# {{ENDIF}}
      - "traefik.http.routers.${PROJECT_NAME}-chrome.middlewares=forwardauth@file,${PROJECT_NAME}-chrome-redirect@docker,${PROJECT_NAME}-chrome-strip@docker"
      - "traefik.http.services.${PROJECT_NAME}-chrome.loadbalancer.server.port=6080"
      - "traefik.http.middlewares.${PROJECT_NAME}-chrome-redirect.redirectregex.regex=^/chrome$$"
      - "traefik.http.middlewares.${PROJECT_NAME}-chrome-redirect.redirectregex.replacement=/chrome/"
      - "traefik.http.middlewares.${PROJECT_NAME}-chrome-strip.stripprefix.prefixes=/chrome"
    volumes:
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
    networks:
      - swe-network
    restart: unless-stopped

  swe-swe:
    build:
      context: .
      dockerfile: Dockerfile
# {{IF NO_SSL}}
    ports:
      # App preview port for split-pane iframe (prepend "1" to SWE_PORT)
      # Direct mapping when no SSL (traefik handles this port when SSL is enabled)
      - "1${SWE_PORT:-1977}:9899"
# {{ENDIF}}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "swe.project=${PROJECT_NAME}"
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.rule=PathPrefix(`/`)"
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.priority=10"
# {{IF SSL}}
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.tls=true"
# {{ENDIF}}
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.middlewares=forwardauth@file"
      - "traefik.http.routers.${PROJECT_NAME}-swe-swe.service=${PROJECT_NAME}-swe-swe"
      - "traefik.http.services.${PROJECT_NAME}-swe-swe.loadbalancer.server.port=9898"
# {{IF SSL}}
      # Preview proxy routing through traefik for TLS termination
      - "traefik.http.routers.${PROJECT_NAME}-preview.rule=PathPrefix(`/`)"
      - "traefik.http.routers.${PROJECT_NAME}-preview.entrypoints=previewsecure"
      - "traefik.http.routers.${PROJECT_NAME}-preview.tls=true"
      - "traefik.http.routers.${PROJECT_NAME}-preview.middlewares=forwardauth@file"
      - "traefik.http.routers.${PROJECT_NAME}-preview.service=${PROJECT_NAME}-preview"
      - "traefik.http.services.${PROJECT_NAME}-preview.loadbalancer.server.port=9899"
# {{ENDIF}}
    depends_on:
      - chrome
    volumes:
      # Mount project directory to /workspace
      - ${WORKSPACE_DIR:-.}:/workspace
      # Mount worktrees to /worktrees for cleaner agent path separation
      - ${WORKSPACE_DIR:-.}/.swe-swe/worktrees:/worktrees
      # Mount persistent home for auth/config storage
      - ./home:/home/app
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
# {{IF SSL}}
      # SSL certificate for download endpoint
      - ${HOME}/.swe-swe/tls:/etc/traefik/tls:ro
# {{ENDIF}}
      # {{IF DOCKER}}
      # Mount Docker socket for container to run Docker commands on host
      - /var/run/docker.sock:/var/run/docker.sock
      # {{ENDIF}}
      # Tmpfs for file uploads - ensures writable regardless of bind mount permissions
      - type: tmpfs
        target: /workspace/.swe-swe/uploads
        tmpfs:
          size: 100M
          mode: 0777
    working_dir: /workspace
    networks:
      - swe-network
    environment:
      # Pass through API keys (edit or set as environment variables)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Enterprise certificates (if configured during swe-swe init)
      - NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS:-}
      - SSL_CERT_FILE=${SSL_CERT_FILE:-}
      # Browser automation via MCP Playwright connected to chrome service
      - BROWSER_WS_ENDPOINT=ws://chrome:9223
      # App preview proxy target port (for split-pane iframe)
      - SWE_PREVIEW_TARGET_PORT=${SWE_PREVIEW_TARGET_PORT:-3000}
      # Add other credentials as needed:
      # - GEMINI_API_KEY=${GEMINI_API_KEY}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped

  vscode-proxy:
    image: nginx:latest
    volumes:
      - ./nginx-vscode.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "swe.project=${PROJECT_NAME}"
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-vscode.rule=PathPrefix(`/vscode`)"
      - "traefik.http.routers.${PROJECT_NAME}-vscode.priority=100"
# {{IF SSL}}
      - "traefik.http.routers.${PROJECT_NAME}-vscode.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-vscode.tls=true"
# {{ENDIF}}
      - "traefik.http.routers.${PROJECT_NAME}-vscode.middlewares=forwardauth@file"
      - "traefik.http.services.${PROJECT_NAME}-vscode.loadbalancer.server.port=8081"
    depends_on:
      - code-server
    networks:
      - swe-network
    restart: unless-stopped

  code-server:
    build:
      context: code-server
      args:
        UID: {{UID}}
        GID: {{GID}}
    command:
      - "--bind-addr=0.0.0.0:8080"
      - "--auth=none"
    labels:
      - "swe.project=${PROJECT_NAME}"
    volumes:
      # Mount project directory (same path as swe-swe container for git worktree compatibility)
      - ${WORKSPACE_DIR:-.}:/workspace
      # Mount worktrees to /worktrees for cleaner agent path separation
      - ${WORKSPACE_DIR:-.}/.swe-swe/worktrees:/worktrees
      # Mount persistent home for VSCode settings/extensions
      - ./home:/home/coder
      # Enterprise certificates (if certs/ directory exists with certificates)
      - ./certs:/swe-swe/certs:ro
    working_dir: /workspace
    networks:
      - swe-network
    environment:
      - TZ=${TZ:-UTC}
      # Enterprise certificates (if configured during swe-swe init)
      - NODE_EXTRA_CA_CERTS=${NODE_EXTRA_CA_CERTS:-}
      - SSL_CERT_FILE=${SSL_CERT_FILE:-}
    restart: unless-stopped
networks:
  swe-network:
    driver: bridge
