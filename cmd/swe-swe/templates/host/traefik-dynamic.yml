# Traefik dynamic configuration for swe-swe

http:
  middlewares:
    # ForwardAuth middleware for session-based authentication
    forwardauth:
      forwardAuth:
        address: "http://auth:4180/swe-swe-auth/verify"
        # Trust X-Forwarded-* headers for proper URL handling
        trustForwardHeader: true

    # Rate limiting for login endpoint to prevent brute force
    login-ratelimit:
      rateLimit:
        average: 5
        burst: 10
        period: 1m

  routers:
    # Traefik dashboard protected by ForwardAuth
    # Note: Only match traefik's internal API paths, not /api/recording/* which goes to swe-swe
    dashboard:
      rule: "PathPrefix(`/api/http`) || PathPrefix(`/api/tcp`) || PathPrefix(`/api/entrypoints`) || PathPrefix(`/api/overview`) || PathPrefix(`/dashboard`)"
      service: "api@internal"
      middlewares:
        - "forwardauth"
      priority: 150
# {{IF SSL}}
      entryPoints:
        - "websecure"
# {{ENDIF}}
# {{IF SELFSIGN}}
      tls: {}
# {{ENDIF}}
# {{IF LETSENCRYPT}}
      tls:
        certResolver: letsencrypt
        domains:
          - main: "{{DOMAIN}}"
# {{ENDIF}}

# {{IF SELFSIGN}}
# TLS configuration for self-signed certificate
tls:
  stores:
    default:
      defaultCertificate:
        certFile: /etc/traefik/tls/server.crt
        keyFile: /etc/traefik/tls/server.key
  certificates:
    - certFile: /etc/traefik/tls/server.crt
      keyFile: /etc/traefik/tls/server.key
# {{ENDIF}}
