<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>swe-swe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            background: #0f1729;
            color: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
        }

        /* Main container */
        .app {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }
        .header__logo {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 8px;
        }
        .header__logo svg {
            width: 24px;
            height: 24px;
        }
        .header__text h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
        }
        .header__text p {
            font-size: 10px;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Main content */
        .main {
            flex: 1;
            padding: 0 32px 32px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Section headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .section-header__left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-header__icon {
            width: 24px;
            height: 24px;
            color: #64748b;
        }
        .section-header__title {
            font-size: 20px;
            font-weight: 600;
            color: #f8fafc;
        }
        .section-header__count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: #7c3aed;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            border-radius: 12px;
        }

        /* New Session button */
        .btn-new-session {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-new-session:hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }
        .btn-new-session svg {
            width: 16px;
            height: 16px;
        }

        /* Sessions section */
        .sessions-section {
            margin-bottom: 40px;
        }

        /* Session cards container */
        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Session card */
        .session-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }
        .session-card:hover {
            border-color: #334155;
            background: rgba(30, 41, 59, 0.7);
        }

        .session-card__top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .session-card__info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .session-card__repo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
        }
        .session-card__repo svg {
            width: 18px;
            height: 18px;
            color: #64748b;
        }
        .session-card__branch {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #22c55e;
        }
        .session-card__branch svg {
            width: 14px;
            height: 14px;
        }
        .session-card__branch--pink {
            color: #ec4899;
        }

        /* Agent badge */
        .agent-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            border: 1px solid;
        }
        .agent-badge--claude {
            color: #f97316;
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
        }
        .agent-badge--goose {
            color: #14b8a6;
            border-color: #14b8a6;
            background: rgba(20, 184, 166, 0.1);
        }
        .agent-badge--gemini {
            color: #3b82f6;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .agent-badge--codex {
            color: #10b981;
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .agent-badge--aider {
            color: #22c55e;
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .agent-badge--custom {
            color: #a855f7;
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        /* Session meta row */
        .session-card__meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .session-card__meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #94a3b8;
        }
        .session-card__meta-item svg {
            width: 14px;
            height: 14px;
            color: #64748b;
        }

        /* Session actions */
        .session-card__actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn-join {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(124, 58, 237, 0.1);
            color: #a78bfa;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn-join:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.4);
        }
        .btn-join svg {
            width: 16px;
            height: 16px;
        }
        .btn-end {
            padding: 10px 16px;
            background: transparent;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-end:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        /* Recordings section */
        .recordings-section {
            margin-bottom: 40px;
        }
        .recordings-section .section-header__left {
            gap: 12px;
        }

        /* Recording card */
        .recording-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        .recording-card:hover {
            border-color: #334155;
            background: rgba(30, 41, 59, 0.7);
        }

        .recording-card__play {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 50%;
            color: #a78bfa;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .recording-card__play:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.4);
        }
        .recording-card__play svg {
            width: 18px;
            height: 18px;
            margin-left: 2px;
        }

        .recording-card__info {
            flex: 1;
            min-width: 0;
        }
        .recording-card__title {
            font-size: 15px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }
        .recording-card__meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
            flex-wrap: wrap;
        }
        .recording-card__branch {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
        }
        .recording-card__dot {
            color: #475569;
        }

        .recording-card__right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .recording-card__status {
            font-size: 13px;
            font-weight: 500;
        }
        .recording-card__status--expires {
            color: #f59e0b;
        }
        .recording-card__status--saved {
            color: #22c55e;
        }

        .recording-card__btn-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-icon:hover {
            background: rgba(100, 116, 139, 0.1);
            color: #94a3b8;
        }
        .btn-icon--keep:hover {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .btn-icon--delete:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        .btn-view {
            padding: 8px 16px;
            background: transparent;
            color: #f8fafc;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn-view:hover {
            background: rgba(248, 250, 252, 0.1);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .empty-state__icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: #475569;
        }
        .empty-state__text {
            font-size: 14px;
        }

        /* iOS Safari Warning */
        .ios-safari-warning {
            display: none;
            max-width: 800px;
            margin: 0 auto 24px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
        }
        .ios-safari-warning__title {
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .ios-safari-warning__text {
            color: #fcd34d;
            font-size: 13px;
        }

        /* Footer */
        .footer {
            padding: 24px 32px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .footer-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #1e293b;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .footer-link:hover {
            border-color: #334155;
            color: #f8fafc;
        }
        .footer-link svg {
            width: 16px;
            height: 16px;
        }

        /* New Session Dialog */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .dialog {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dialog__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .dialog__title {
            font-size: 20px;
            font-weight: 600;
            color: #f8fafc;
        }
        .dialog__close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #64748b;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .dialog__close:hover {
            background: rgba(100, 116, 139, 0.1);
            color: #f8fafc;
        }
        .dialog__field {
            margin-bottom: 20px;
        }
        .dialog__label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .dialog__row {
            display: flex;
            gap: 8px;
        }
        .dialog__input {
            flex: 1;
            padding: 12px 14px;
            font-size: 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-family: inherit;
        }
        .dialog__input:focus {
            outline: none;
            border-color: #7c3aed;
        }
        .dialog__input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dialog__input::placeholder {
            color: #64748b;
        }
        .dialog__next {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .dialog__next:hover:not(:disabled) {
            background: #475569;
        }
        .dialog__next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dialog__agents {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .dialog__agent {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .dialog__agent:hover:not(.dialog__agent--disabled) {
            border-color: #7c3aed;
        }
        .dialog__agent--selected {
            border-color: #7c3aed;
            background: rgba(124, 58, 237, 0.1);
        }
        .dialog__agent--disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .dialog__agent-icon {
            font-size: 18px;
        }
        .dialog__agent-name {
            font-size: 14px;
            color: #f8fafc;
        }
        .dialog__agent input[type="radio"] {
            display: none;
        }
        .dialog__footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            gap: 16px;
        }
        .dialog__error {
            color: #ef4444;
            font-size: 13px;
            flex: 1;
        }
        .dialog__loading {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
        }
        .dialog__spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #334155;
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .dialog__start {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .dialog__start:hover:not(:disabled) {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        .dialog__start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile responsiveness */
        @media (max-width: 640px) {
            .header {
                padding: 12px 16px;
            }
            .header__logo {
                width: 36px;
                height: 36px;
            }
            .header__logo svg {
                width: 20px;
                height: 20px;
            }
            .header__text h1 {
                font-size: 16px;
            }
            .header__text p {
                font-size: 9px;
            }

            .main {
                padding: 0 16px 24px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .section-header__title {
                font-size: 18px;
            }
            .btn-new-session {
                width: 100%;
                justify-content: center;
            }

            .session-card {
                padding: 16px;
            }
            .session-card__top {
                flex-direction: column;
                gap: 8px;
            }
            .session-card__repo {
                font-size: 15px;
            }
            .session-card__meta {
                flex-wrap: wrap;
                gap: 12px;
            }
            .session-card__actions {
                flex-direction: column;
                gap: 8px;
            }
            .btn-join {
                width: 100%;
            }
            .btn-end {
                width: 100%;
                text-align: center;
            }

            .recording-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 16px;
            }
            .recording-card__play {
                width: 36px;
                height: 36px;
            }
            .recording-card__play svg {
                width: 14px;
                height: 14px;
            }
            .recording-card__info {
                width: 100%;
            }
            .recording-card__title {
                font-size: 14px;
            }
            .recording-card__meta {
                font-size: 12px;
            }
            .recording-card__right {
                width: 100%;
                justify-content: space-between;
            }
            .recording-card__status {
                font-size: 12px;
            }

            .footer {
                padding: 16px 20px;
            }
            .footer-link {
                flex: 1;
                justify-content: center;
                min-width: 140px;
            }

            .dialog {
                padding: 20px;
                border-radius: 12px;
            }
            .dialog__agents {
                flex-direction: column;
            }
            .dialog__agent {
                width: 100%;
            }
            .dialog__footer {
                flex-direction: column;
                gap: 12px;
            }
            .dialog__start {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- New Session dialog -->
    <div class="dialog-overlay" id="new-session-dialog-overlay">
        <div class="dialog">
            <div class="dialog__header">
                <div class="dialog__title">New Session</div>
                <button class="dialog__close" id="new-session-close">&times;</button>
            </div>
            <div class="dialog__field">
                <label class="dialog__label">Repository</label>
                <div class="dialog__row">
                    <input type="text" class="dialog__input" id="new-session-repo" list="repo-history" placeholder="Repository URL or /workspace">
                    <datalist id="repo-history"></datalist>
                    <button class="dialog__next" id="new-session-repo-next">Next</button>
                </div>
            </div>
            <div class="dialog__field">
                <label class="dialog__label">Branch (optional)</label>
                <div class="dialog__row">
                    <input type="text" class="dialog__input" id="new-session-branch" list="branch-list" placeholder="Leave blank for default branch" disabled>
                    <datalist id="branch-list"></datalist>
                    <button class="dialog__next" id="new-session-branch-next" disabled>Next</button>
                </div>
            </div>
            <div class="dialog__field">
                <label class="dialog__label">Agent</label>
                <div class="dialog__agents" id="new-session-agents">
                    {{range .Agents}}
                    <label class="dialog__agent dialog__agent--disabled" data-agent="{{.Assistant.Binary}}">
                        <input type="radio" name="new-session-agent" value="{{.Assistant.Binary}}" disabled>
                        <span class="dialog__agent-icon">{{if eq .Assistant.Binary "claude"}}üß†{{else if eq .Assistant.Binary "gemini"}}‚ú®{{else if eq .Assistant.Binary "codex"}}ü§ñ{{else if eq .Assistant.Binary "goose"}}ü™ø{{else if eq .Assistant.Binary "aider"}}üõ†{{else}}‚öôÔ∏è{{end}}</span>
                        <span class="dialog__agent-name">{{.Assistant.Name}}</span>
                    </label>
                    {{end}}
                </div>
            </div>
            <div class="dialog__footer">
                <div class="dialog__error" id="new-session-error"></div>
                <div class="dialog__loading" id="new-session-loading">
                    <div class="dialog__spinner"></div>
                    <span id="new-session-loading-text">Loading...</span>
                </div>
                <button class="dialog__start" id="new-session-start" disabled>Start Session</button>
            </div>
        </div>
    </div>

    <div class="app">
        <header class="header">
            <div class="header__logo">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" fill="#7c3aed"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" fill="#7c3aed"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" fill="#7c3aed"/>
                    <rect x="14" y="14" width="7" height="7" rx="1.5" fill="#7c3aed"/>
                </svg>
            </div>
            <div class="header__text">
                <h1>swe-swe</h1>
                <p>Session Manager</p>
            </div>
        </header>

        <div class="ios-safari-warning" id="ios-safari-warning">
            <div class="ios-safari-warning__title">iOS Safari + Self-Signed Certs</div>
            <div class="ios-safari-warning__text">
                WebSocket connections may not work in Safari with self-signed certificates.
                Please use <strong>Chrome</strong> or another browser on iOS for best results.
            </div>
        </div>

        <main class="main">
            <!-- Active Sessions Section -->
            <section class="sessions-section">
                <div class="section-header">
                    <div class="section-header__left">
                        <svg class="section-header__icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                            <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                            <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                            <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <h2 class="section-header__title">Active Sessions</h2>
                    </div>
                    <button class="btn-new-session" onclick="openNewSessionDialog('', '{{.NewUUID}}', {{.Debug}})">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        New Session
                    </button>
                </div>

                <div class="sessions-list">
                    {{range .Agents}}
                    {{range .Sessions}}
                    <div class="session-card">
                        <div class="session-card__top">
                            <div class="session-card__info">
                                <div class="session-card__repo">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 17V7C4 5.89543 4.89543 5 6 5H18C19.1046 5 20 5.89543 20 7V17C20 18.1046 19.1046 19 18 19H6C4.89543 19 4 18.1046 4 17Z" stroke="currentColor" stroke-width="2"/>
                                        <path d="M8 9H8.01M12 9H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M7 13L10 16L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
                                    </svg>
                                    {{if .Name}}{{.Name}}{{else}}session-{{.UUIDShort}}{{end}}
                                </div>
                            </div>
                            <span class="agent-badge agent-badge--{{.Assistant}}">{{.Assistant}}</span>
                        </div>
                        <div class="session-card__meta">
                            <span class="session-card__meta-item">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17 21V19C17 16.7909 15.2091 15 13 15H5C2.79086 15 1 16.7909 1 19V21M23 21V19C22.9986 17.177 21.765 15.5857 20 15.13M16 3.13C17.7699 3.58317 19.0078 5.17798 19.0078 7.005C19.0078 8.83202 17.7699 10.4268 16 10.88M13 7C13 9.20914 11.2091 11 9 11C6.79086 11 5 9.20914 5 7C5 4.79086 6.79086 3 9 3C11.2091 3 13 4.79086 13 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                {{.ClientCount}} active
                            </span>
                            <span class="session-card__meta-item">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                {{.DurationStr}}
                            </span>
                        </div>
                        <div class="session-card__actions">
                            <a href="/session/{{.UUID}}?assistant={{.Assistant}}{{if $.Debug}}&debug=1{{end}}" class="btn-join">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M8 21H16M12 17V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Join Session
                            </a>
                            <button class="btn-end" onclick="endSession('{{.UUID}}', this)">End</button>
                        </div>
                    </div>
                    {{end}}
                    {{end}}
                </div>
            </section>

            <!-- Session Recordings Section -->
            {{$hasRecordings := false}}
            {{range .Agents}}{{if .Recordings}}{{$hasRecordings = true}}{{end}}{{end}}
            {{if $hasRecordings}}
            <section class="recordings-section">
                <div class="section-header">
                    <div class="section-header__left">
                        <svg class="section-header__icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 8V21H3V8M1 3H23V8H1V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M10 12H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <h2 class="section-header__title">Session Recordings</h2>
                    </div>
                </div>

                <div class="recordings-list">
                    {{range .Agents}}
                    {{range .Recordings}}
                    <div class="recording-card" data-uuid="{{.UUID}}">
                        <a href="/recording/{{.UUID}}" class="recording-card__play" title="Play recording">
                            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5.14V19.14L19 12.14L8 5.14Z"/>
                            </svg>
                        </a>
                        <div class="recording-card__info">
                            <h3 class="recording-card__title">{{if .Name}}{{.Name}}{{else}}session-{{.UUIDShort}}{{end}}</h3>
                            <div class="recording-card__meta">
                                <span>{{.EndedAgo}}</span>
                            </div>
                        </div>
                        <div class="recording-card__right">
                            <span class="recording-card__status {{if .IsKept}}recording-card__status--saved{{else}}recording-card__status--expires{{end}}">
                                {{if .IsKept}}Saved{{else}}Expires in {{.ExpiresIn}}{{end}}
                            </span>
                            <div class="recording-card__btn-group">
                                {{if .IsKept}}
                                <button class="btn-icon btn-icon--keep" title="Kept indefinitely">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M19 21L12 16L5 21V5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-icon--delete" onclick="deleteRecording('{{.UUID}}', this)" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                {{else}}
                                <button class="btn-icon btn-icon--keep" onclick="keepRecording('{{.UUID}}', this)" title="Keep to prevent auto-deletion">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M19 21L12 16L5 21V5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-icon--delete" onclick="deleteRecording('{{.UUID}}', this)" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                {{end}}
                            </div>
                            <a href="/recording/{{.UUID}}" class="btn-view">View</a>
                        </div>
                    </div>
                    {{end}}
                    {{end}}
                </div>
            </section>
            {{end}}
        </main>

        <footer class="footer">
            {{if .HasSSLCert}}
            <a href="/ssl/ca.crt" class="footer-link">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
                    <path d="M7 11V7C7 4.23858 9.23858 2 12 2C14.7614 2 17 4.23858 17 7V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Install SSL Certificate
            </a>
            {{end}}
            <a href="https://github.com/choonkeat/swe-swe" target="_blank" rel="noopener" class="footer-link">
                <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
            </a>
        </footer>
    </div>

    <script>
        // Detect iOS Safari and show warning for self-signed cert scenarios
        (function() {
            var ua = navigator.userAgent;
            var isIOS = /iPad|iPhone|iPod/.test(ua);
            var isSafari = /Safari/.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/.test(ua);
            var isHTTPS = location.protocol === 'https:';

            if (isIOS && isSafari && isHTTPS) {
                var warning = document.getElementById('ios-safari-warning');
                if (warning) {
                    warning.style.display = 'block';
                }
            }
        })();

        // Use embedded rendering for recordings on mobile devices.
        (function() {
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           (navigator.maxTouchPoints > 0 && window.innerWidth < 1024);
            if (isMobile) {
                document.querySelectorAll('a.recording-card__play, a.btn-view').forEach(function(link) {
                    if (link.href && link.href.indexOf('?') === -1) {
                        link.href += '?render=embedded';
                    }
                });
            }
        })();

        function endSession(uuid, button) {
            if (!confirm('End this session?')) {
                return;
            }
            fetch('/api/session/' + uuid + '/end', {
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    var card = button.closest('.session-card');
                    if (card) {
                        card.remove();
                    }
                    // Update count
                    var countEl = document.querySelector('.section-header__count');
                    if (countEl) {
                        var currentCount = parseInt(countEl.textContent) || 0;
                        if (currentCount > 1) {
                            countEl.textContent = currentCount - 1;
                        } else {
                            countEl.remove();
                        }
                    }
                } else {
                    alert('Failed to end session');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        function deleteRecording(uuid, button) {
            if (!confirm('Delete this recording?')) {
                return;
            }
            fetch('/api/recording/' + uuid, {
                method: 'DELETE'
            }).then(function(response) {
                if (response.ok) {
                    var card = button.closest('.recording-card');
                    if (card) {
                        card.remove();
                    }
                } else {
                    alert('Failed to delete recording');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        function keepRecording(uuid, button) {
            fetch('/api/recording/' + uuid + '/keep', {
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    var card = button.closest('.recording-card');
                    if (card) {
                        // Update status text
                        var statusEl = card.querySelector('.recording-card__status');
                        if (statusEl) {
                            statusEl.textContent = 'Saved';
                            statusEl.classList.remove('recording-card__status--expires');
                            statusEl.classList.add('recording-card__status--saved');
                        }
                        // Update keep button to show filled bookmark
                        var keepBtn = card.querySelector('.btn-icon--keep');
                        if (keepBtn) {
                            keepBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 21L12 16L5 21V5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="currentColor"/></svg>';
                            keepBtn.title = 'Kept indefinitely';
                            keepBtn.onclick = null;
                        }
                    }
                } else {
                    alert('Failed to keep recording');
                }
            }).catch(function(err) {
                alert('Error: ' + err.message);
            });
        }

        // New Session Dialog functionality
        (function() {
            var overlay = document.getElementById('new-session-dialog-overlay');
            var closeBtn = document.getElementById('new-session-close');
            var repoInput = document.getElementById('new-session-repo');
            var repoNextBtn = document.getElementById('new-session-repo-next');
            var branchInput = document.getElementById('new-session-branch');
            var branchNextBtn = document.getElementById('new-session-branch-next');
            var agentsContainer = document.getElementById('new-session-agents');
            var startBtn = document.getElementById('new-session-start');
            var errorDiv = document.getElementById('new-session-error');
            var loadingDiv = document.getElementById('new-session-loading');
            var loadingText = document.getElementById('new-session-loading-text');
            var repoHistoryList = document.getElementById('repo-history');
            var branchList = document.getElementById('branch-list');

            var dialogState = {
                sessionUUID: '',
                debug: false,
                repoPath: '',
                selectedBranch: '',
                selectedAgent: '',
                preSelectedAgent: ''
            };

            var REPO_HISTORY_KEY = 'swe-swe-repo-history';

            function loadRepoHistory() {
                try {
                    var history = JSON.parse(localStorage.getItem(REPO_HISTORY_KEY) || '[]');
                    repoHistoryList.innerHTML = '';
                    history.forEach(function(url) {
                        var option = document.createElement('option');
                        option.value = url;
                        repoHistoryList.appendChild(option);
                    });
                } catch (e) {
                    console.error('Failed to load repo history:', e);
                }
            }

            function saveToRepoHistory(url) {
                try {
                    var history = JSON.parse(localStorage.getItem(REPO_HISTORY_KEY) || '[]');
                    history = history.filter(function(u) { return u !== url; });
                    history.unshift(url);
                    history = history.slice(0, 10);
                    localStorage.setItem(REPO_HISTORY_KEY, JSON.stringify(history));
                } catch (e) {
                    console.error('Failed to save repo history:', e);
                }
            }

            function getDefaultRepoUrl() {
                return '{{.DefaultRepoUrl}}';
            }

            function resetDialog() {
                repoInput.value = getDefaultRepoUrl();
                repoInput.disabled = false;
                repoNextBtn.disabled = false;
                branchInput.value = '';
                branchInput.disabled = true;
                branchNextBtn.disabled = true;
                branchList.innerHTML = '';
                errorDiv.textContent = '';
                loadingDiv.style.display = 'none';
                startBtn.disabled = true;

                var agentLabels = agentsContainer.querySelectorAll('.dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.add('dialog__agent--disabled');
                    label.classList.remove('dialog__agent--selected');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = true;
                        radio.checked = false;
                    }
                });

                dialogState.repoPath = '';
                dialogState.selectedBranch = '';
                dialogState.selectedAgent = '';
            }

            window.openNewSessionDialog = function(preSelectedAgent, sessionUUID, debug) {
                dialogState.sessionUUID = sessionUUID;
                dialogState.debug = debug;
                dialogState.preSelectedAgent = preSelectedAgent || '';

                resetDialog();
                loadRepoHistory();
                overlay.style.display = 'flex';

                setTimeout(function() { repoInput.focus(); }, 100);
            };

            function closeDialog() {
                overlay.style.display = 'none';
                resetDialog();
            }

            function showError(msg) {
                errorDiv.textContent = msg;
                loadingDiv.style.display = 'none';
            }

            function showLoading(msg) {
                loadingText.textContent = msg || 'Loading...';
                loadingDiv.style.display = 'flex';
                errorDiv.textContent = '';
            }

            function hideLoading() {
                loadingDiv.style.display = 'none';
            }

            function enableBranchField() {
                branchInput.disabled = false;
                branchNextBtn.disabled = false;
            }

            function enableAgentSelection() {
                var agentLabels = agentsContainer.querySelectorAll('.dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.remove('dialog__agent--disabled');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = false;
                    }
                });

                if (dialogState.preSelectedAgent) {
                    var preSelectedLabel = agentsContainer.querySelector('[data-agent="' + dialogState.preSelectedAgent + '"]');
                    if (preSelectedLabel) {
                        var radio = preSelectedLabel.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            preSelectedLabel.classList.add('dialog__agent--selected');
                            dialogState.selectedAgent = dialogState.preSelectedAgent;
                            startBtn.disabled = false;
                        }
                    }
                }
            }

            repoNextBtn.addEventListener('click', function() {
                var repoUrl = repoInput.value.trim();
                if (!repoUrl) {
                    showError('Please enter a repository URL');
                    return;
                }

                showLoading('Preparing repository...');
                repoInput.disabled = true;
                repoNextBtn.disabled = true;

                fetch('/api/repo/prepare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: repoUrl })
                })
                .then(function(response) {
                    if (!response.ok) {
                        return response.json().then(function(data) {
                            throw new Error(data.error || 'Failed to prepare repository');
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    dialogState.repoPath = data.path;
                    saveToRepoHistory(repoUrl);
                    return fetch('/api/repo/branches?path=' + encodeURIComponent(data.path));
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Failed to fetch branches');
                    }
                    return response.json();
                })
                .then(function(data) {
                    hideLoading();
                    branchList.innerHTML = '';
                    (data.branches || []).forEach(function(branch) {
                        var option = document.createElement('option');
                        option.value = branch;
                        branchList.appendChild(option);
                    });
                    enableBranchField();
                    branchInput.focus();
                })
                .catch(function(err) {
                    hideLoading();
                    repoInput.disabled = false;
                    repoNextBtn.disabled = false;
                    showError(err.message || 'Failed to prepare repository');
                });
            });

            branchNextBtn.addEventListener('click', function() {
                dialogState.selectedBranch = branchInput.value.trim();
                enableAgentSelection();
            });

            branchInput.addEventListener('change', function() {
                if (branchInput.value) {
                    dialogState.selectedBranch = branchInput.value.trim();
                    enableAgentSelection();
                }
            });

            agentsContainer.addEventListener('click', function(e) {
                var label = e.target.closest('.dialog__agent');
                if (!label || label.classList.contains('dialog__agent--disabled')) {
                    return;
                }

                var allLabels = agentsContainer.querySelectorAll('.dialog__agent');
                allLabels.forEach(function(l) {
                    l.classList.remove('dialog__agent--selected');
                });

                label.classList.add('dialog__agent--selected');
                var radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    dialogState.selectedAgent = radio.value;
                    startBtn.disabled = false;
                }
            });

            startBtn.addEventListener('click', function() {
                if (!dialogState.selectedAgent) {
                    showError('Please select an agent');
                    return;
                }

                var url = '/session/' + dialogState.sessionUUID + '?assistant=' + encodeURIComponent(dialogState.selectedAgent);
                if (dialogState.debug) {
                    url += '&debug=1';
                }
                if (dialogState.repoPath && dialogState.repoPath !== '/workspace') {
                    url += '&pwd=' + encodeURIComponent(dialogState.repoPath);
                }
                if (dialogState.selectedBranch) {
                    url += '&name=' + encodeURIComponent(dialogState.selectedBranch);
                }

                window.location.href = url;
            });

            closeBtn.addEventListener('click', closeDialog);

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeDialog();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && overlay.style.display === 'flex') {
                    closeDialog();
                }
            });

            repoInput.addEventListener('input', function() {
                branchInput.value = '';
                branchInput.disabled = true;
                branchNextBtn.disabled = true;
                branchList.innerHTML = '';
                dialogState.selectedBranch = '';
                dialogState.selectedAgent = '';
                startBtn.disabled = true;

                var agentLabels = agentsContainer.querySelectorAll('.dialog__agent');
                agentLabels.forEach(function(label) {
                    label.classList.add('dialog__agent--disabled');
                    label.classList.remove('dialog__agent--selected');
                    var radio = label.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.disabled = true;
                        radio.checked = false;
                    }
                });
            });
        })();
    </script>
</body>
</html>
